<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>제품 관리 | Fine Defense Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f4f6f9;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: #0f2679;
      color: #fff;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding: 30px 20px;
      box-sizing: border-box;
    }
    .sidebar h2 { margin-bottom: 30px; font-size: 1.2rem; }
    .sidebar nav a {
      display:block; padding: 10px; margin-bottom:8px;
      color:#cfd6ff; text-decoration:none; border-radius:6px;
    }
    .sidebar nav a:hover, .sidebar nav .active {
      background: rgba(255,255,255,0.18); color:#fff;
    }

    .main {
      margin-left: 240px;
      width: calc(100% - 240px);
      padding: 30px;
      box-sizing: border-box;
    }

    .topbar {
      background: #fff;
      padding: 16px 22px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .topbar h1 { font-size: 1.2rem; margin:0; }

    .panel {
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      padding:20px;
      margin-bottom:25px;
    }

    .panel h2 {
      margin-top:0;
      font-size:1.1rem;
      margin-bottom:12px;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:0.9rem;
      box-sizing:border-box;
      margin-bottom:10px;
    }

    textarea { min-height:80px; }

    button {
      padding:8px 14px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:0.9rem;
    }

    .btn-primary { background:#0f2679; color:#fff; }
    .btn-secondary { background:#e5e7eb; color:#333; }
    .btn-danger { background:#e63946; color:#fff; }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
    }
    th, td {
      border-bottom:1px solid #eee;
      padding:8px;
      text-align:left;
      vertical-align:middle;
    }
    th { background:#f9fafb; }

    img.thumb {
      width:60px;
      height:40px;
      object-fit:cover;
      border-radius:4px;
      border:1px solid #ddd;
    }

    .actions button { margin-right:4px; }
  </style>
</head>

<body>

  <aside class="sidebar">
    <h2>Fine Defense</h2>
    <nav>
      <a href="/kr/admin/dashboard.html">대시보드</a>
      <a href="/kr/admin/newsroom_list.html">뉴스룸 관리</a>
      <a href="/kr/admin/files.html">자료실 관리</a>
      <a href="/kr/admin/products.html" class="active">제품 관리</a>
    </nav>
  </aside>

  <div class="main">
    <div class="topbar">
      <h1>제품 관리</h1>
      <button id="logoutBtn" class="btn-secondary">로그아웃</button>
    </div>

    <!-- 등록/수정 -->
    <section class="panel">
      <h2>제품 등록 / 수정</h2>

      <form id="productForm">
        <label>카테고리</label>
        <select id="category">
          <option value="sub_towed">수중이동형케이블 (sub_towed)</option>
        </select>

        <label>언어</label>
        <select id="lang">
          <option value="kr">한국어</option>
          <option value="en">English</option>
        </select>

        <label>정렬순서</label>
        <input type="number" id="order_index" value="0">

        <label>제품명</label>
        <input type="text" id="title">

        <label>설명</label>
        <textarea id="description"></textarea>

        <label>상세 페이지 링크</label>
        <input type="text" id="link">

        <label>썸네일 이미지</label>
        <input type="file" id="image" name="image" accept="image/*">


        <button type="button" id="saveBtn" class="btn-primary">등록</button>
        <button type="button" id="resetBtn" class="btn-secondary">초기화</button>
      </form>
    </section>

    <!-- 목록 -->
    <section class="panel">
      <h2>제품 목록</h2>

      <div style="margin-bottom:10px;">
        <label>카테고리</label>
        <select id="filterCategory">
          <option value="sub_towed">수중이동형케이블 (sub_towed)</option>
        </select>

        <label>언어</label>
        <select id="filterLang">
          <option value="kr">한국어</option>
          <option value="en">English</option>
        </select>

        <button id="reloadBtn" class="btn-secondary">불러오기</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>이미지</th>
            <th>제품명</th>
            <th>링크</th>
            <th>카테고리</th>
            <th>언어</th>
            <th>순서</th>
            <th>관리</th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
    </section>
  </div>


<script>

/* 로그인 체크 */
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "admin") {
  alert("관리자 로그인이 필요합니다.");
  location.href = "/kr/admin/login.html";
}

/* 로그아웃 */
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.clear();
  location.href = "/kr/admin/login.html";
});

/* form 기본 제출 막기 (핵심!!) */
document.getElementById("productForm").addEventListener("submit", e => {
  e.preventDefault();
});

/* 요소 */
const catSel = document.getElementById("category");
const langSel = document.getElementById("lang");
const orderInput = document.getElementById("order_index");
const titleInput = document.getElementById("title");
const descInput = document.getElementById("description");
const linkInput = document.getElementById("link");
const imgInput = document.getElementById("image");

const filterCategory = document.getElementById("filterCategory");
const filterLang = document.getElementById("filterLang");
const tableBody = document.getElementById("productTableBody");

let editingId = null;


/* ================================
   목록 불러오기
================================ */
async function loadProducts() {
  const category = filterCategory.value;
  const lang = filterLang.value;

  const res = await fetch(`/api/products/list/${category}?lang=${lang}`);
  const data = await res.json();

  tableBody.innerHTML = data
    .map(
      (p) => `
        <tr>
          <td>${p.id}</td>
          <td>${p.image ? `<img src="${p.image}" class="thumb">` : "-"}</td>
          <td>${p.title}</td>
          <td>${p.link || "-"}</td>
          <td>${p.category}</td>
          <td>${p.lang}</td>
          <td>${p.order_index}</td>
          <td>
            <button class="btn-secondary" onclick="editProduct(${p.id})">수정</button>
            <button class="btn-danger" onclick="deleteProduct(${p.id})">삭제</button>
          </td>
        </tr>
      `
    )
    .join("");
}

document.getElementById("reloadBtn").addEventListener("click", loadProducts);


/* ================================
   등록/수정
================================ */
document.getElementById("saveBtn").addEventListener("click", async () => {

  const fd = new FormData();
  fd.append("category", catSel.value);
  fd.append("lang", langSel.value);
  fd.append("title", titleInput.value.trim());
  fd.append("description", descInput.value.trim());
  fd.append("link", linkInput.value.trim());
  fd.append("order_index", orderInput.value);

  if (imgInput.files[0]) {
    fd.append("image", imgInput.files[0]);
  }

  const url = editingId ? `/api/products/${editingId}` : `/api/products`;
  const method = editingId ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: { Authorization: `Bearer ${token}` },
    body: fd,
  });

  if (!res.ok) return alert("저장 실패");

  alert(editingId ? "수정 완료" : "등록 완료");

  resetForm();
  loadProducts();
});


/* ================================
   수정 모드
================================ */
window.editProduct = async (id) => {
  const res = await fetch(`/api/products/${id}`, {
    headers: { Authorization: `Bearer ${token}` },
  });

  if (!res.ok) return alert("불러오기 실패");

  const p = await res.json();
  editingId = p.id;

  catSel.value = p.category;
  langSel.value = p.lang;
  orderInput.value = p.order_index;
  titleInput.value = p.title;
  descInput.value = p.description || "";
  linkInput.value = p.link || "";

  document.getElementById("saveBtn").textContent = "수정 완료";

  window.scrollTo({ top: 0, behavior: "smooth" });
};


/* ================================
   삭제
================================ */
window.deleteProduct = async (id) => {
  if (!confirm("정말 삭제하시겠습니까?")) return;

  const res = await fetch(`/api/products/${id}`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${token}` },
  });

  if (!res.ok) return alert("삭제 실패");

  alert("삭제 완료");
  loadProducts();
};


/* ================================
   초기화
================================ */
document.getElementById("resetBtn").addEventListener("click", resetForm);

function resetForm() {
  editingId = null;
  catSel.value = "sub_towed";
  langSel.value = "kr";
  orderInput.value = 0;
  titleInput.value = "";
  descInput.value = "";
  linkInput.value = "";
  imgInput.value = "";

  document.getElementById("saveBtn").textContent = "등록";
}


/* 초기 실행 */
loadProducts();

</script>

</body>
</html>
