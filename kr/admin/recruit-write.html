<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>채용공고 작성 | Fine Defense Admin</title>

  <link rel="stylesheet" href="./css/admin.css">
  <!-- Toast UI Editor -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />

  <!-- 세션 -->
  <script type="module" src="/js/session_manager.js"></script>
  <script type="module" src="./js/dashboard_session_timer.js"></script>

  <style>
    .panel {
      background:#fff;
      padding:30px 34px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(15,38,121,0.08);
      max-width: 1000px;   /* 또는 1100px */
      margin: 0 auto;      /* 중앙 정렬 보장 */
    }

    .form-group {
      margin-bottom:22px;
    }

    label {
      font-weight:600;
      display:block;
      margin-bottom:6px;
    }

    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #ccd3f0;
      font-size:0.95rem;
    }

    textarea {
      min-height: 260px;
      line-height: 1.6;
      resize:vertical;
    }

    .btns {
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:30px;
      border-top: 1px solid #e1e6f5;
      padding-top: 20px;
    }

    .checkbox-group {
    margin-top: 20px;
    }

    .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    cursor: pointer;
    }

    /* 기존 label block 스타일 영향 제거 */
    .checkbox-label {
    margin-bottom: 0;
    }


    input:focus,
    select:focus,
    textarea:focus {
    outline: none;
    border-color: #0f2679;
    box-shadow: 0 0 0 2px rgba(15,38,121,0.15);
    }

    .required {
    color: #d9534f;
    font-weight: 700;
    margin-left: 2px;
    }

    /* checkbox / radio는 전역 input 스타일에서 제외 */
    input[type="checkbox"],
    input[type="radio"] {
    width: auto;
    padding: 0;
    border: none;
    box-shadow: none;
    }


  .toastui-editor-contents img {
    max-width: 720px;
    width: 100%;
    height: auto;
  }



  </style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar" data-active="recruit"></div>

<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="title">채용공고 작성</div>

    <div style="display:flex; align-items:center; gap:12px;">
      <span id="session-timer" class="session-timer">세션 계산중...</span>

      <div class="topbar-user" id="topbarUser">
        <span id="topbarUserName">관리자</span> ▾
        <div class="user-dropdown" id="userDropdown"></div>
      </div>

      <button onclick="location.href='../index.html'">홈으로</button>
    </div>
  </div>

  <section class="panel">

    <div class="form-group">
      <label>공고 제목 <span class="required">*</span></label>
      <input type="text" id="title" placeholder="채용공고 제목">
    </div>

    <div class="form-group">
      <label>고용 형태</label>
      <select id="employment_type">
        <option value="">선택</option>
        <option>정규직</option>
        <option>계약직</option>
        <option>인턴</option>
        <option>기타</option>
      </select>
    </div>

    <div class="form-group">
      <label>경력</label>
      <select id="career_level">
        <option value="">선택</option>
        <option>신입</option>
        <option>경력</option>
        <option>무관</option>
      </select>
    </div>

    <div class="form-group">
      <label>근무지</label>
      <input type="text" id="location" placeholder="예: 서울 / 판교">
    </div>

    <div class="form-group">
      <label>정렬 순서</label>
      <input type="number" id="sort_order" value="9999">
    </div>

    <div class="form-group">
      <label>공고 내용 <span class="required">*</span></label>
      <div id="editor"></div>
    </div>

    <div class="form-group checkbox-group">
    <label class="checkbox-label">
        <input type="checkbox" id="is_active" checked>
        공개 상태
    </label>
    </div>


    <div class="btns">
      <button class="btn btn-primary" onclick="submitRecruit()">저장</button>
      <button class="btn btn-gray" onclick="history.back()">취소</button>
    </div>

  </section>
</div>

<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>
<script src="./js/topbar_user_menu.js"></script>

<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
let editor;

document.addEventListener("DOMContentLoaded", () => {
  requireEditPermission();

  editor = new toastui.Editor({
    el: document.querySelector("#editor"),
    height: "420px",
    initialEditType: "wysiwyg",
    previewStyle: "vertical",
    language: "ko",
    usageStatistics: false,

    hooks: {
      addImageBlobHook: async (blob, callback) => {
        try {
          const formData = new FormData();
          formData.append("image", blob);

          const res = await fetch("/api/uploads/editor/image", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token")
            },
            body: formData
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text);
          }

          const result = await res.json();
          callback(result.url, blob.name);

        } catch (err) {
          console.error("❌ 이미지 업로드 실패:", err);
          alert("이미지 업로드 실패");
        }
      }
    }
  });
});

loadSidebar("recruit");


const params = new URLSearchParams(location.search);
const recruitId = params.get("id");

/* ===============================
   수정 모드 로드
=============================== */
if (recruitId) {
  document.getElementById("pageTitle").innerText = "채용공고 수정";
  loadRecruit();
}

async function loadRecruit() {
  const res = await fetch(`/api/recruit/${recruitId}`, {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  });
  const r = await res.json();

  document.getElementById("title").value = r.title;
  document.getElementById("employment_type").value = r.employment_type || "";
  document.getElementById("career_level").value = r.career_level || "";
  document.getElementById("location").value = r.location || "";
  document.getElementById("sort_order").value = r.sort_order ?? 9999;
  editor.setHTML(r.content || "");
  document.getElementById("is_active").checked = !!r.is_active;
}

/* ===============================
   저장
=============================== */
async function submitRecruit() {
  const payload = {
    title: document.getElementById("title").value.trim(),
    employment_type: document.getElementById("employment_type").value,
    career_level: document.getElementById("career_level").value,
    location: document.getElementById("location").value,
    sort_order: Number(document.getElementById("sort_order").value || 9999),
    content: editor.getHTML(),
    is_active: document.getElementById("is_active").checked ? 1 : 0
  };

  if (!payload.title || !editor.getHTML().trim()) {
    alert("제목과 내용은 필수입니다.");
    return;
  }

  const url = recruitId
    ? `/api/recruit/update/${recruitId}`
    : `/api/recruit/create`;

  const method = recruitId ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    alert("저장되었습니다.");
    location.href = "/kr/admin/recruit-manage.html";
  } else {
    const text = await res.text();
    console.error("❌ 저장 실패:", text);
    alert("저장 실패 (콘솔 확인)");
  }
}
</script>

</body>
</html>
