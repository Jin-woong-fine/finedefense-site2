<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>문의 상세 | Fine Defense 관리자</title>

  <link rel="stylesheet" href="./css/admin.css">

  <!-- Quill for read-only display -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      background: #f5f7fb;
    }

    .container {
      margin-left: 240px;
      padding: 40px 50px;
      max-width: 900px;
    }

    h2 {
      font-size: 22px;
      color: #0f2679;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .field-box {
      margin-bottom: 25px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .field-title {
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    #contentBox {
      min-height: 150px;
    }

    .status-chip {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-0 {
      background: #ffe8e8;
      color: #d10000;
    }
    .status-1 {
      background: #e5f3ff;
      color: #0058c6;
    }

    .btn {
      padding: 10px 18px;
      background: #0f2679;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }

    .btn.disabled {
      background: #999 !important;
      cursor: not-allowed !important;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="sidebar"></div>

  <div class="container">
    <h2>문의 상세</h2>

    <!-- 이름 -->
    <div class="field-box">
      <div class="field-title">이름</div>
      <div id="nameText"></div>
    </div>

    <!-- 이메일 -->
    <div class="field-box">
      <div class="field-title">이메일</div>
      <div id="emailText"></div>
    </div>

    <!-- 제목 -->
    <div class="field-box">
      <div class="field-title">제목</div>
      <div id="subjectText"></div>
    </div>

    <!-- 문의 내용 (Quill read-only) -->
    <div class="field-box">
      <div class="field-title">문의 내용</div>
      <div id="contentBox"></div>
    </div>

    <!-- 상태 -->
    <div class="field-box">
      <div class="field-title">상태</div>
      <span id="statusChip"></span>
      <button id="statusBtn" class="btn">확인 처리</button>
    </div>

    <!-- 관리자 메모 -->
    <div class="field-box">
      <div class="field-title">관리자 메모</div>
      <textarea id="adminNote"></textarea>
      <button id="saveNoteBtn" class="btn">메모 저장</button>
    </div>
  </div>

  <script src="./js/sidebar.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const role = localStorage.getItem("role");

    let inquiryData;
    let quill;

    document.addEventListener("DOMContentLoaded", () => {
      loadInquiry();

      // 권한에 따라 기능 숨기기
      if (role === "editor" || role === "viewer") {
        document.getElementById("statusBtn").style.display = "none";
        document.getElementById("adminNote").disabled = true;
        document.getElementById("saveNoteBtn").disabled = true;
        document.getElementById("saveNoteBtn").classList.add("disabled");
      }
    });

    // ========= 상세 데이터 로드 =========
    async function loadInquiry() {
      const res = await fetch(`/api/inquiry/view/${id}`, {
        headers: { Authorization: "Bearer " + localStorage.getItem("token") }
      });
      inquiryData = await res.json();

      document.getElementById("nameText").textContent = inquiryData.name;
      document.getElementById("emailText").textContent = inquiryData.email;
      document.getElementById("subjectText").textContent = inquiryData.subject ?? "-";
      document.getElementById("adminNote").value = inquiryData.admin_note ?? "";

      renderStatus();

      // Quill read-only content
      quill = new Quill("#contentBox", {
        theme: "snow",
        readOnly: true,
      });

      quill.root.innerHTML = inquiryData.message.replace(/\n/g, "<br>");
    }

    // ========= 상태 표시 =========
    function renderStatus() {
      const chip = document.getElementById("statusChip");
      if (inquiryData.status === 0) {
        chip.className = "status-chip status-0";
        chip.textContent = "미확인";
      } else {
        chip.className = "status-chip status-1";
        chip.textContent = "확인";
      }
    }

    // ========= 상태 변경 (admin 이상만 가능) =========
    document.getElementById("statusBtn").onclick = async () => {
      if (role === "editor" || role === "viewer") return;

      const newStatus = 1;
      const res = await fetch(`/api/inquiry/status/${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({ status: newStatus })
      });

      if (res.ok) {
        alert("확인 처리 완료");
        inquiryData.status = newStatus;
        renderStatus();
      }
    };

    // ========= 메모 저장 =========
    document.getElementById("saveNoteBtn").onclick = async () => {
      if (role === "editor" || role === "viewer") return;

      const note = document.getElementById("adminNote").value;

      const res = await fetch(`/api/inquiry/note/${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({ note })
      });

      if (res.ok) {
        alert("메모 저장 완료");
      }
    };
  </script>
</body>
</html>
