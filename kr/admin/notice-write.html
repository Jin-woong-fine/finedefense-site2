<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ì‚¬í•­ ì‘ì„± | Fine Defense ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Toast UI Editor CSS -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- ê´€ë¦¬ì ê³µí†µ CSS -->
  <link rel="stylesheet" href="./css/admin.css">

  <style>
    .panel h2 { margin-top: 0; }

    .file-list { margin-top: 10px; }
    .file-item {
      margin-bottom: 6px;
      font-size: 0.9rem;
      background: #f4f4f4;
      padding: 8px 12px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .help-text {
      font-size: 0.8rem;
      color: #777;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<!-- â­ ì‚¬ì´ë“œë°” -->
<div id="sidebar" data-active="notice"></div>

<div class="main">

  <div class="topbar">
    <h2>ê³µì§€ì‚¬í•­ ì‘ì„±</h2>
    <div>
      <button class="btn btn-primary" onclick="location.href='./notice-list.html'">ëª©ë¡ìœ¼ë¡œ</button>
      <button id="logoutBtn" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <form id="noticeForm" enctype="multipart/form-data">

    <!-- ============================ -->
    <!-- ğŸ“Œ ê³µì§€ ì •ë³´ ì…ë ¥ -->
    <!-- ============================ -->
    <section class="panel">
      <h2>ê³µì§€ ì •ë³´ ì…ë ¥</h2>

      <input id="title" class="input" placeholder="ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />

      <select id="lang" class="input">
        <option value="kr">í•œêµ­ì–´</option>
        <option value="en">English</option>
      </select>

      <!-- ì •ë ¬ìˆœë²ˆ -->
      <input
        id="sort_order"
        class="input"
        type="number"
        placeholder="ì •ë ¬ ìˆœë²ˆ (ì‘ì„ìˆ˜ë¡ ìƒë‹¨)"
        min="1"
      />
      <div class="help-text">
        *ë©”ì¸ê³µì§€ì²˜ëŸ¼ ìƒë‹¨ ê³ ì •í•˜ê³  ì‹¶ì€ ê²½ìš° ë‚®ì€ ìˆ«ì(ì˜ˆ: 1,2,3)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.  
        ë¯¸ì…ë ¥ ì‹œ ê¸°ë³¸ê°’ = 9999
      </div>

      <h3 style="margin-top:20px;">ê³µì§€ ë‚´ìš©</h3>
      <div id="editor" style="border:1px solid #ccc;border-radius:6px;"></div>
    </section>

    <!-- ============================ -->
    <!-- ğŸ“ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ -->
    <!-- ============================ -->
    <section class="panel">
      <h3>ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</h3>

      <input type="file" id="files" name="files" multiple class="input" />

      <div id="filePreview" class="file-list"></div>

      <button type="submit" class="btn btn-primary" style="margin-top:15px;">
        ë“±ë¡
      </button>
    </section>

  </form>

</div>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>

<!-- Toast Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸ” ê¶Œí•œ ì²´í¬ + ë¡œê·¸ì•„ì›ƒ ì„¤ì •
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  (function () {
    requireAdminOrEditor();
    document.getElementById("logoutBtn").addEventListener("click", logout);
  })();


  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      âœï¸ Toast UI Editor ì´ˆê¸°í™”
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    hideModeSwitch: true,
    usageStatistics: false,
    toolbarItems: [
      ['heading', 'bold', 'italic', 'strike'],
      ['hr', 'quote'],
      ['ul', 'ol'],
      ['table', 'link']
      /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ ì œê±°ë¨ (ë‰´ìŠ¤ë£¸ë§Œ ì´ë¯¸ì§€ ì‚¬ìš©) */
    ]
  });


  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸ“ ì²¨ë¶€íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const fileInput = document.getElementById("files");
  const filePreview = document.getElementById("filePreview");

  fileInput.addEventListener("change", (e) => {
    const files = [...e.target.files];

    if (!files.length) {
      filePreview.innerHTML = "";
      return;
    }

    filePreview.innerHTML = files
      .map(f => `<div class="file-item">${f.name}</div>`)
      .join("");
  });


  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸš€ ê³µì§€ì‚¬í•­ ë“±ë¡ ìš”ì²­
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  document.getElementById("noticeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value.trim();
    const lang = document.getElementById("lang").value;
    const sortOrderRaw = document.getElementById("sort_order").value;
    const sortOrder = sortOrderRaw === "" ? 9999 : Number(sortOrderRaw);
    const content = editor.getHTML();
    const files = document.getElementById("files").files;

    if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
    if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

    const formData = new FormData();
    formData.append("title", title);
    formData.append("content", content);
    formData.append("lang", lang);
    formData.append("sort_order", isNaN(sortOrder) ? 9999 : sortOrder);

    [...files].forEach(f => formData.append("files", f));

    const token = localStorage.getItem("token");

    const res = await fetch("/api/posts/notice/create", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: formData
    });

    const result = await res.json();

    if (res.ok) {
      alert("ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "./notice-list.html";
    } else {
      console.error(result);
      alert("ë“±ë¡ ì‹¤íŒ¨: " + (result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  });

</script>

</body>
</html>
