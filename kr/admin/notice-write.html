<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ì‚¬í•­ ì‘ì„± | Fine Defense ê´€ë¦¬ì</title>

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css">

  <!-- Toast UI Editor CSS -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- ì„¸ì…˜ ë§¤ë‹ˆì € -->
  <script type="module" src="/js/session_manager.js"></script>
  <script type="module" src="./js/dashboard_session_timer.js"></script>


  <style>
    .panel h2 { margin-top: 0; }

    .file-list { margin-top: 10px; }
    .file-item {
      margin-bottom: 6px;
      font-size: 0.9rem;
      background: #f4f4f4;
      padding: 8px 12px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .help-text {
      font-size: 0.8rem;
      color: #777;
      margin-top: 4px;
    }
  </style>

<style>
    /* ===========================================================
      ğŸ“Œ ê³µì§€ ê¸°ë³¸ ì •ë³´ ì…ë ¥ UI (ê°•ì œ ì ìš©)
    =========================================================== */

    /* ê³µì§€ ì •ë³´ ì„¹ì…˜ ë‚´ë¶€ë§Œ ì ìš© */
    .panel input.input,
    .panel select.input {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      background: #fafbff;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
    }

    .panel input.input::placeholder {
      color: #9aa4b2;
    }

    .panel input.input:focus,
    .panel select.input:focus {
      outline: none;
      border-color: #0f2679;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(15, 38, 121, 0.12);
    }

    /* ê³µì§€ ì œëª© ê°•ì¡° */
    #title {
      font-size: 17px;
      font-weight: 600;
    }

    /* ì–¸ì–´ + ì •ë ¬ìˆœë²ˆ ì •ë ¬ */
    .notice-meta {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 14px;
      margin-top: 12px;
    }

    /* ì…€ë ‰íŠ¸ í™”ì‚´í‘œ í†µì¼ */
    select.input {
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #0f2679 50%),
        linear-gradient(135deg, #0f2679 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px;
      background-repeat: no-repeat;
      padding-right: 36px;
      cursor: pointer;
    }

    /* ë„ì›€ë§ í…ìŠ¤íŠ¸ ì •ë¦¬ */
    .help-text {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }
  </style>


</head>

<body>

  <!-- â­ ì‚¬ì´ë“œë°” -->
  <div id="sidebar" data-active="notice"></div>

  <!-- â­ ë©”ì¸ -->
  <div class="main">

    <!-- =======================
         TOPBAR
    ======================== -->
    <div class="topbar">
      <div class="title">ê³µì§€ì‚¬í•­ ì‘ì„±</div>

      <div style="display:flex; align-items:center; gap:12px;">
        <span id="session-timer" class="session-timer">ì„¸ì…˜ ê³„ì‚°ì¤‘...</span>

        <div class="topbar-user" id="topbarUser">
          <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
          <div class="user-dropdown" id="userDropdown"></div>
        </div>

        <button onclick="location.href='../index.html'">í™ˆìœ¼ë¡œ</button>
      </div>
    </div>

    <!-- =======================
         FORM
    ======================== -->
    <form id="noticeForm" enctype="multipart/form-data">

      <!-- ğŸ”¹ ê¸°ì¡´ ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° -->
      <section class="panel">
        <h2>ê¸°ì¡´ ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ì„ íƒ)</h2>

        <select id="copyFromNotice" class="input">
          <option value="">ê¸°ì¡´ ê³µì§€ ì„ íƒ (ì„ íƒì‚¬í•­)</option>
        </select>

        <div class="help-text">
          ì„ íƒí•œ ê³µì§€ì˜ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™€ ì‹ ê·œ ê³µì§€ë¡œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
          (ì˜ë¬¸ ê³µì§€ ì‘ì„± ì‹œ í•œê¸€ ê³µì§€ë¥¼ ë¶ˆëŸ¬ì™€ ë²ˆì—­í•˜ëŠ” ìš©ë„ë¡œ í™œìš©)<br>
          *ì •ë ¬ ìˆœë²ˆì€ <b>ê¸°ë³¸ê°’ 9999</b>ë¡œ ë‘ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.<br>
          *ë©”ì¸ì— ë…¸ì¶œì´ í•„ìš”í•œ ê³µì§€ì‚¬í•­ë§Œ <b>1, 2, 3</b> ë“± ì‘ì€ ìˆ«ìë¡œ ì„¤ì •í•˜ì„¸ìš”.
        </div>

        <button
          type="button"
          class="btn btn-secondary"
          onclick="loadFromExistingNotice()"
        >
          ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
      </section>

      <!-- =======================
           ê³µì§€ ì •ë³´ ì…ë ¥
      ======================== -->
      <section class="panel">
        <h2>ê³µì§€ ì •ë³´ ì…ë ¥</h2>

        <input id="title" class="input" placeholder="ê³µì§€ ì œëª©" />

        <div class="notice-meta">
          <select id="lang" class="input">
            <option value="kr">í•œêµ­ì–´</option>
            <option value="en">English</option>
          </select>

          <input
            id="sort_order"
            class="input"
            type="number"
            placeholder="ì •ë ¬ ìˆœë²ˆ"
            min="1"
          />
        </div>

        <div class="help-text">
          *ìƒë‹¨ì— ê³ ì •í•˜ê³  ì‹¶ì€ ê³µì§€ëŠ” <b>1, 2, 3</b>ì²˜ëŸ¼ ì‘ì€ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
          *ë¯¸ì…ë ¥ ì‹œ ê¸°ë³¸ê°’ì€ <b>9999</b>ì…ë‹ˆë‹¤.
        </div>

        <h3 style="margin-top:20px;">ê³µì§€ ë‚´ìš©</h3>
        <div id="editor" style="border:1px solid #ccc;border-radius:6px;"></div>
      </section>

      <!-- =======================
           ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ
      ======================== -->
      <section class="panel">
        <h3>ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</h3>

        <input type="file" id="files" name="files" multiple class="input" />
        <div id="filePreview" class="file-list"></div>

        <button type="submit" class="btn btn-primary" style="margin-top:15px;">
          ë“±ë¡
        </button>
      </section>

    </form>

  </div>

  <!-- =======================
       ê³µí†µ JS
  ======================== -->
  <script src="/kr/admin/js/common_auth.js"></script>
  <script src="/kr/admin/js/sidebar.js"></script>
  <script src="./js/topbar_user_menu.js"></script>

  <!-- Toast UI Editor -->
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <script>
    /* =========================
       ê¶Œí•œ / ì‚¬ì´ë“œë°”
    ========================= */
    requireAdminOrEditor();
    loadSidebar("notice");

    /* =========================
       Editor ì´ˆê¸°í™”
    ========================= */
    const editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      hideModeSwitch: true,
      usageStatistics: false,
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol'],
        ['table', 'link']
      ]
    });

    /* =========================
       ê¸°ì¡´ ê³µì§€ ëª©ë¡ ë¡œë“œ
    ========================= */
    async function loadNoticeList() {
      try {
        const res = await fetch("/api/posts/list/notice?lang=all", {
          headers: { Authorization: "Bearer " + localStorage.getItem("token") }
        });

        const out = await res.json();
        const list = Array.isArray(out) ? out : (out.list || []);

        const select = document.getElementById("copyFromNotice");

        list.forEach(n => {
          if (!n?.id || !n?.title) return;

          const opt = document.createElement("option");
          opt.value = n.id;
          opt.textContent = `[${(n.lang || "kr").toUpperCase()}] ${n.title}`;
          select.appendChild(opt);
        });

      } catch (e) {
        console.error("ê³µì§€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", e);
      }
    }

    loadNoticeList();

    /* =========================
       ê¸°ì¡´ ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    ========================= */
    async function loadFromExistingNotice() {
      const id = document.getElementById("copyFromNotice").value;
      if (!id) return;

      if (!confirm("ì„ íƒí•œ ê³µì§€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì…ë ¥ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.")) {
        return;
      }

      const res = await fetch(`/api/posts/notice/${id}`, {
        headers: { Authorization: "Bearer " + localStorage.getItem("token") }
      });

      const out = await res.json();
      const n = out.notice || out.post;

      if (!n) {
        alert("ê³µì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      document.getElementById("title").value = n.title || "";
      document.getElementById("sort_order").value = 9999;

      editor.setHTML(n.content || n.content_html || "");

      alert("ê³µì§€ ë‚´ìš©ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.\në²ˆì—­ í›„ ì €ì¥í•˜ì„¸ìš”.");
    }

    /* =========================
       íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
    ========================= */
    document.getElementById("files").addEventListener("change", (e) => {
      const list = [...e.target.files]
        .map(f => `<div class="file-item">${f.name}</div>`)
        .join("");
      document.getElementById("filePreview").innerHTML = list;
    });

    /* =========================
       ê³µì§€ ë“±ë¡
    ========================= */
    document.getElementById("noticeForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData();
      formData.append("title", document.getElementById("title").value.trim());
      formData.append("content", editor.getHTML());
      formData.append("lang", document.getElementById("lang").value);

      const sort = document.getElementById("sort_order").value || 9999;
      formData.append("sort_order", Number(sort));

      const files = document.getElementById("files").files;
      [...files].forEach(f => formData.append("files", f));

      const token = localStorage.getItem("token");

      const res = await fetch("/api/posts/notice/create", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: formData
      });

      const out = await res.json();

      if (res.ok) {
        alert("ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.href = "./notice-list.html";
      } else {
        alert("ë“±ë¡ ì‹¤íŒ¨: " + (out.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    });
  </script>

</body>


</html>
