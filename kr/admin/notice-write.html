<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ì‚¬í•­ ì‘ì„± | Fine Defense Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css" />

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
</head>

<body data-admin-page="notice">

<!-- ì¸ì¦ -->
<script src="/kr/admin/js/common_auth.js"></script>
<script>
  requireAdminOrEditor();
</script>

<!-- =========================================================
     ADMIN LAYOUT
========================================================= -->
<div class="admin-wrapper">

  <!-- ===================== SIDEBAR ====================== -->
  <aside id="sidebar" class="admin-sidebar"></aside>

  <!-- ===================== CONTENT ====================== -->
  <div class="admin-content">
    <div class="main">

      <!-- ===================== TOPBAR ====================== -->
      <div class="topbar">
        <div class="title">ê³µì§€ì‚¬í•­ ì‘ì„±</div>

        <div class="topbar-right">
          <button id="topbarUser" class="topbar-user" type="button">
            <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
          </button>

          <div id="userDropdown" class="user-dropdown">
            <button class="dropdown-item" data-action="logout" type="button">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>

          <button type="button" onclick="location.href='./notice-list.html'">
            ëª©ë¡ìœ¼ë¡œ
          </button>
        </div>
      </div>

      <!-- ===================== FORM ====================== -->
      <form id="noticeForm" enctype="multipart/form-data">

        <!-- ğŸ”¹ ê³µì§€ ê¸°ë³¸ ì •ë³´ -->
        <section class="panel">
          <h2>ê³µì§€ ì •ë³´ ì…ë ¥</h2>

          <input
            id="title"
            class="search-input"
            placeholder="ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
          />

          <select id="lang" class="search-input">
            <option value="kr">í•œêµ­ì–´</option>
            <option value="en">English</option>
          </select>

          <input
            id="sort_order"
            class="search-input"
            type="number"
            placeholder="ì •ë ¬ ìˆœë²ˆ (ê¸°ë³¸ê°’ 9999)"
            min="1"
          />

          <div class="help-text">
            â€¢ ìƒë‹¨ ê³ ì • ê³µì§€ëŠ” ë‚®ì€ ìˆ«ì (ì˜ˆ: 1,2,3)<br>
            â€¢ ë¯¸ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ 9999 ì ìš©
          </div>

          <h2 style="margin-top:24px;">ê³µì§€ ë‚´ìš©</h2>
          <div id="editor"></div>
        </section>

        <!-- ğŸ”¹ ì²¨ë¶€íŒŒì¼ -->
        <section class="panel">
          <h2>ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ</h2>

          <input
            type="file"
            id="files"
            name="files"
            multiple
            class="search-input"
          />

          <div id="filePreview" style="margin-top:12px;"></div>

          <div style="margin-top:24px;">
            <button type="submit" class="btn-primary">
              ë“±ë¡
            </button>
          </div>
        </section>

      </form>

    </div>
  </div>
</div>

<!-- =========================================================
     SCRIPTS
========================================================= -->
<script src="/kr/admin/js/sidebar.js"></script>
<script src="/kr/admin/js/topbar.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  /* ì‚¬ì´ë“œë°” ë¡œë“œ */
  loadSidebar("notice");

  /* Toast UI Editor */
  const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    hideModeSwitch: true,
    usageStatistics: false,
    toolbarItems: [
      ['heading', 'bold', 'italic', 'strike'],
      ['hr', 'quote'],
      ['ul', 'ol'],
      ['table', 'link']
    ]
  });

  /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° */
  document.getElementById("files").addEventListener("change", (e) => {
    const files = [...e.target.files];
    document.getElementById("filePreview").innerHTML =
      files.map(f => `<div class="file-item">${f.name}</div>`).join("");
  });

  /* ê³µì§€ ë“±ë¡ */
  document.getElementById("noticeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append("title", title.value.trim());
    formData.append("content", editor.getHTML());
    formData.append("lang", lang.value);
    formData.append("sort_order", sort_order.value || 9999);

    [...files.files].forEach(f => formData.append("files", f));

    const res = await fetch("/api/posts/notice/create", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token")
      },
      body: formData
    });

    if (res.ok) {
      alert("ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "./notice-list.html";
    } else {
      const out = await res.json();
      alert("ë“±ë¡ ì‹¤íŒ¨: " + (out.message || "ì˜¤ë¥˜"));
    }
  });
</script>

</body>
</html>
