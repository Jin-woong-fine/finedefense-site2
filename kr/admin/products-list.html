<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì œí’ˆ ëª©ë¡ | Fine Defense ê´€ë¦¬ì</title>

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="./css/admin.css" />

  <style>
  /* ===============================
     TABLE (NOTICE STYLE)
  =============================== */
  .product-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 12px;
    border-radius: 12px;
    overflow: hidden;
    font-size: 0.95rem;
  }

  .product-table th,
  .product-table td {
    padding: 11px 14px;
    border-bottom: 1px solid #e1e6f5;
    text-align: left;
  }

  .product-table th {
    background: #0f2679;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .product-table tbody tr:hover td {
    background: #f0f4ff;
  }

  .product-table th:nth-child(1),
  .product-table td:nth-child(1),
  .product-table th:nth-child(2),
  .product-table td:nth-child(2),
  .product-table th:nth-child(3),
  .product-table td:nth-child(3) {
    text-align: center;
  }

  /* ===============================
     SORT ORDER INPUT
  =============================== */
  .order-input {
    width: 60px;
    padding: 5px 6px;
    border-radius: 6px;
    border: 1px solid #ccd3f0;
    font-size: 0.85rem;
    text-align: center;
  }

  .order-input:focus {
    outline: none;
    border-color: #0f2679;
    box-shadow: 0 0 0 2px rgba(15, 38, 121, 0.15);
  }

  /* ===============================
     LANG FILTER
  =============================== */
  .lang-filter {
    display: inline-flex;
    gap: 6px;
  }

  .lang-btn {
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid #cfd6ee;
    background: #ffffff;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .lang-btn.active {
    background: #0f2679;
    color: #ffffff;
    border-color: #0f2679;
  }



  .no-en {
      color: #ff3b30;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>

<!-- ğŸ”µ ì‚¬ì´ë“œë°” -->
<div id="sidebar"></div>

<div class="main">

  <!-- ğŸ”µ TOPBAR (ìœ ì§€) -->
  <div class="topbar">
    <div class="title">ì œí’ˆ ê´€ë¦¬</div>

    <div style="display:flex; align-items:center; gap:12px;">
      <span id="session-timer" class="session-timer">ì„¸ì…˜ ê³„ì‚°ì¤‘...</span>

      <div class="topbar-user" id="topbarUser">
        <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
        <div class="user-dropdown" id="userDropdown"></div>
      </div>

      <button onclick="location.href='../index.html'">í™ˆìœ¼ë¡œ</button>
    </div>
  </div>

  <!-- ğŸ”µ í˜ì´ì§€ ì•¡ì…˜ -->
  <div style="margin-bottom:20px;">
    <button class="btn btn-primary" onclick="location.href='products-add.html'">
      + ì‹ ê·œë“±ë¡ (KR)
    </button>
  </div>

  <!-- ğŸ”µ ëª©ë¡ íŒ¨ë„ -->
  <section class="panel">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2>ë“±ë¡ëœ ì œí’ˆ</h2>
    </div>

    <table class="product-table">
      <thead>
        <tr>
          <th style="width:60px;">ë²ˆí˜¸</th>
          <th style="width:70px;">ìˆœë²ˆ</th>
          <th style="width:90px;">ì–¸ì–´ ë²„ì „</th>
          <th style="width:120px;">ì¹´í…Œê³ ë¦¬</th>
          <th style="width:100px;">ì´ë¯¸ì§€</th>
          <th>ì œí’ˆëª…</th>
          <th style="width:140px;">ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody id="productTbody">
        <tr><td colspan="7">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
      </tbody>
    </table>

  </section>

</div>

<!-- ê³µí†µ JS -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>

<script>
/* ===============================
   ì¹´í…Œê³ ë¦¬ í‘œì‹œìš© í•œê¸€ ë§¤í•‘
================================ */
const categoryMap = {
  towed: "ìˆ˜ì¤‘ì´ë™í˜•",
  fixed: "ìˆ˜ì¤‘ê³ ì •í˜•",
  connector: "ìˆ˜ì¤‘ ì»¤ë„¥í„°",
  custom: "ì»¤ìŠ¤í…€"
};

/* ğŸ” ê¶Œí•œ / ì‚¬ì´ë“œë°” */
requireAdminOrEditor();
loadSidebar("products");

/* ì „ì—­ */
let allProducts = [];

/* ===============================
   ë°ì´í„° ë¡œë“œ (ê´€ë¦¬ì ì „ìš©)
================================ */
async function loadProducts() {
  try {
    const res = await fetch("/api/admin/products", {
      headers: authHeaders()
    });

    allProducts = await res.json();
    renderTable();
  } catch (e) {
    console.error(e);
  }
}

/* ===============================
   í…Œì´ë¸” ë Œë”
================================ */
function renderTable() {
  const tbody = document.getElementById("productTbody");

  if (!allProducts.length) {
    tbody.innerHTML = `<tr><td colspan="7">ì œí’ˆ ì—†ìŒ</td></tr>`;
    return;
  }

  allProducts.sort((a, b) => {
    const aOrder = Number.isFinite(a.sort_order) ? a.sort_order : 9999;
    const bOrder = Number.isFinite(b.sort_order) ? b.sort_order : 9999;
    return aOrder - bOrder;
  });

  tbody.innerHTML = allProducts.map((p, i) => `
    <tr>
      <td>${i + 1}</td>

      <td>
        <input class="order-input"
          type="number"
          min="1"
          value="${Number.isFinite(p.sort_order) ? p.sort_order : 9999}"
          data-id="${p.id}"
          onchange="saveSortOrder(this)">
      </td>

      <td>
        KR
        ${
          p.has_en
            ? '<span style="color:#0f2679;"> / EN</span>'
            : '<span class="en-missing"> (EN ì—†ìŒ)</span>'
        }
      </td>


      <td>${categoryMap[p.category] || p.category}</td>

      <td>
        <img
          src="${p.thumbnail || '/kr/admin/img/noimage.png'}"
          style="
            width:80px;
            height:50px;
            object-fit:cover;
            border-radius:6px;
            border:1px solid #e1e6f5;
          "
        />
      </td>

      <td onclick="openProduct(${p.id})" style="cursor:pointer;">
        ${p.title}
      </td>

      <td>
        <button class="btn btn-primary"
          onclick="location.href='products-edit.html?id=${p.id}&lang=kr'">
          KR ìˆ˜ì •
        </button>

        ${
          p.has_en
            ? `<button class="btn btn-secondary"
                onclick="location.href='products-edit.html?id=${p.en_id}&lang=en'">
                EN ìˆ˜ì •
              </button>`
            : `<button class="btn btn-secondary"
                onclick="addTranslate(${p.id})">
                EN ì¶”ê°€
              </button>`
        }

        <button class="btn btn-danger"
          onclick="deleteProduct(${p.id})">
          ì‚­ì œ
        </button>
      </td>
    </tr>
  `).join("");
}

/* ===============================
   ìˆœë²ˆ ì €ì¥
================================ */
async function saveSortOrder(input) {
  const id = Number(input.dataset.id);
  let sort_order = Number(input.value);

  if (!id) return;

  if (!Number.isFinite(sort_order) || sort_order < 1) {
    sort_order = 9999;
    input.value = 9999;
  }

  await fetch("/api/products/sort-order", {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      ...authHeaders()
    },
    body: JSON.stringify({
      orders: [{ id, sort_order }]
    })
  });

  input.style.background = "#e7f7ec";
  setTimeout(() => input.style.background = "", 500);

  loadProducts();
}

/* ===============================
   ì˜ë¬¸ ë²„ì „ ìƒì„±
================================ */
async function addTranslate(id) {
  if (!confirm("ì´ ì œí’ˆì˜ ì˜ë¬¸ ë²„ì „ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const res = await fetch(`/api/products/${id}/translate`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...authHeaders()
    },
    body: JSON.stringify({ lang: "en" })
  });

  const out = await res.json();

  if (!res.ok) {
    alert(out.message || "ì˜ë¬¸ ë²„ì „ ìƒì„± ì‹¤íŒ¨");
    return;
  }

  alert("ì˜ë¬¸ ë²„ì „ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
  loadProducts();
}

/* ===============================
   ì‚­ì œ
================================ */
async function deleteProduct(id) {
  if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  await fetch(`/api/products/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  });

  loadProducts();
}

/* ===============================
   ê³µê°œ í˜ì´ì§€ (KR ê¸°ì¤€)
================================ */
function openProduct(id) {
  window.open(
    `/kr/sub/products/product-view.html?id=${id}&lang=kr`,
    "_blank"
  );
}

/* ì‹œì‘ */
loadProducts();
</script>


</body>
</html>
