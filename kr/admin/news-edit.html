<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ë‰´ìŠ¤ ì‘ì„±/ìˆ˜ì • | Fine Defense</title>

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <link rel="stylesheet" href="./css/admin.css">

  <style>
    .preview-img {
      width: 120px;
      height: 80px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .image-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>

  <!-- ê³µí†µ ì¸ì¦ -->
  <script src="./js/common_auth.js"></script>
  <script>
    requireAdminOrEditor();
  </script>

  <!-- ì‚¬ì´ë“œë°” -->
  <div id="sidebar"></div>
  <script src="./js/sidebar.js"></script>
  <script>
    loadSidebar("newsroom");
  </script>

  <div class="main">
    <div class="topbar">
      <div class="title">ë‰´ìŠ¤ ì‘ì„± / ìˆ˜ì •</div>
    </div>

    <div class="form-box">

      <label>ì–¸ì–´</label>
      <select id="lang">
        <option value="kr">KR</option>
        <option value="en">EN</option>
      </select>

      <label>ì œëª©</label>
      <input id="title" type="text">

      <label>ì´ë¯¸ì§€ (ì—¬ëŸ¬ì¥)</label>
      <input id="images" type="file" accept="image/*" multiple>
      <div id="preview" class="image-row"></div>

      <label>ë‚´ìš©</label>
      <div id="editor"></div>

      <button onclick="save()">ì €ì¥</button>
    </div>
  </div>

  <!-- Toast UI Editor JS -->
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <script>
    let editor;

    document.addEventListener("DOMContentLoaded", () => {
      editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '600px',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical'
      });
    });

    const id = new URLSearchParams(location.search).get("id");

    /* ===============================
       ğŸ“Œ ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    =============================== */
    async function load() {
      if (!id) return;

      const res = await fetch(`/api/posts/detail/${id}`);
      const v = await res.json();

      document.getElementById("lang").value = v.lang;
      document.getElementById("title").value = v.title;

      // Toast Editor ë³¸ë¬¸ ì„¸íŒ…
      editor.setHTML(v.content || "");

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
      (v.images || []).forEach((img) => {
        addPreview("/" + img.replace(/^\/+/, ""));
      });
    }

    function addPreview(src) {
      const img = document.createElement("img");
      img.src = src;
      img.className = "preview-img";
      document.getElementById("preview").appendChild(img);
    }

    /* ===============================
       ğŸ“Œ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
    =============================== */
    document.getElementById("images").addEventListener("change", function () {
      document.getElementById("preview").innerHTML = "";
      for (const f of this.files) {
        const reader = new FileReader();
        reader.onload = (e) => addPreview(e.target.result);
        reader.readAsDataURL(f);
      }
    });

    /* ===============================
       ğŸ“Œ ì €ì¥
    =============================== */
    async function save() {
      const form = new FormData();
      form.append("title", document.getElementById("title").value);
      form.append("lang", document.getElementById("lang").value);
      form.append("content", editor.getHTML());   // â­ Toast Editor ë³¸ë¬¸ ì¶”ì¶œ

      const imgs = document.getElementById("images").files;
      for (const img of imgs) form.append("images", img);

      const token = localStorage.getItem("token");

      const url = id ? `/api/news/edit/${id}` : `/api/news/create`;
      const method = id ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: { Authorization: "Bearer " + token },
        body: form,
      });

      const out = await res.json();
      if (out.message) {
        alert(id ? "ìˆ˜ì • ì™„ë£Œ!" : "ë“±ë¡ ì™„ë£Œ!");
        location.href = "news-list.html";
      } else {
        alert("ì €ì¥ ì‹¤íŒ¨");
      }
    }

    load();
  </script>

</body>
</html>
