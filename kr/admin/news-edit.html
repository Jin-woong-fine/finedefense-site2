  <!-- /kr/admin/news-edit.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‰´ìŠ¤ ì‘ì„±/ìˆ˜ì • | Fine Defense ê´€ë¦¬ì</title>

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css">

  <!-- ì„¸ì…˜ ë§¤ë‹ˆì € -->
  <script type="module" src="/js/session_manager.js"></script>
  <script type="module" src="./js/dashboard_session_timer.js"></script>

  <style>
    /* ===============================
       ğŸ“Œ ë‰´ìŠ¤ ì…ë ¥ UI (ê³µì§€ ìŠ¤íƒ€ì¼)
    =============================== */

    .panel input.input,
    .panel select.input {
      width:100%;
      padding:14px 16px;
      font-size:15px;
      border-radius:10px;
      border:1px solid #d0d7e2;
      background:#fafbff;
    }

    .panel input.input:focus,
    .panel select.input:focus {
      outline:none;
      border-color:#0f2679;
      background:#fff;
      box-shadow:0 0 0 3px rgba(15,38,121,0.12);
    }

    #title {
      font-size:17px;
      font-weight:600;
    }

    .news-meta {
      display:grid;
      grid-template-columns:160px 1fr;
      gap:14px;
      margin-top:12px;
    }

    .image-row {
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .preview-img {
      width:120px;
      height:80px;
      object-fit:cover;
      border-radius:8px;
      border:1px solid #ddd;
    }
  </style>
</head>

<body>

<!-- â­ ì‚¬ì´ë“œë°” -->
<div id="sidebar" data-active="newsroom"></div>

<!-- â­ ë©”ì¸ -->
<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="title">ë‰´ìŠ¤ ì‘ì„± / ìˆ˜ì •</div>

    <div style="display:flex; align-items:center; gap:12px;">
      <span id="session-timer" class="session-timer">ì„¸ì…˜ ê³„ì‚°ì¤‘...</span>

      <div class="topbar-user" id="topbarUser">
        <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
        <div class="user-dropdown" id="userDropdown"></div>
      </div>

      <button onclick="location.href='../index.html'">í™ˆìœ¼ë¡œ</button>
    </div>
  </div>

  <!-- ğŸ“Œ í¼ -->
  <form class="panel" id="newsForm" enctype="multipart/form-data">

    <h2>ë‰´ìŠ¤ ì •ë³´</h2>

    <input id="title" class="input" placeholder="ë‰´ìŠ¤ ì œëª©" />

    <div class="news-meta">
      <select id="lang" class="input">
        <option value="kr">í•œêµ­ì–´</option>
        <option value="en">English</option>
      </select>
    </div>

    <h3 style="margin-top:20px;">ì¸ë„¤ì¼ / ì´ë¯¸ì§€</h3>
    <input id="images" type="file" accept="image/*" multiple class="input">
    <div id="preview" class="image-row"></div>

    <h3 style="margin-top:20px;">ë‰´ìŠ¤ ë‚´ìš©</h3>
    <div id="editor" style="border:1px solid #ccc;border-radius:6px;"></div>

    <button type="submit" class="btn btn-primary" style="margin-top:18px;">
      ì €ì¥
    </button>
  </form>

</div>

<!-- ê³µí†µ JS -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>
<script src="./js/topbar_user_menu.js"></script>

<!-- Toast UI Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  requireEditPermission()
  loadSidebar();

  let editor;
  const id = new URLSearchParams(location.search).get("id");

  document.addEventListener("DOMContentLoaded", () => {
    editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '600px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical'
    });

    load();
  });

  /* ===============================
     ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  =============================== */
  async function load() {
    if (!id) return;

    const res = await fetch(`/api/posts/detail/${id}`);
    const v = await res.json();

    document.getElementById("lang").value = v.lang;
    document.getElementById("title").value = v.title;
    editor.setHTML(v.content || "");

    (v.images || []).forEach(img => {
      addPreview("/" + img.replace(/^\/+/, ""));
    });
  }

  function addPreview(src) {
    const img = document.createElement("img");
    img.src = src;
    img.className = "preview-img";
    document.getElementById("preview").appendChild(img);
  }

  document.getElementById("images").addEventListener("change", function () {
    document.getElementById("preview").innerHTML = "";
    [...this.files].forEach(f => {
      const reader = new FileReader();
      reader.onload = e => addPreview(e.target.result);
      reader.readAsDataURL(f);
    });
  });

  /* ===============================
     ì €ì¥
  =============================== */
  document.getElementById("newsForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = new FormData();
    form.append("title", document.getElementById("title").value);
    form.append("lang", document.getElementById("lang").value);
    form.append("content", editor.getHTML());

    const imgs = document.getElementById("images").files;
    [...imgs].forEach(img => form.append("images", img));

    const token = localStorage.getItem("token");
    const url = id ? `/api/news/edit/${id}` : `/api/news/create`;
    const method = id ? "PUT" : "POST";

    const res = await fetch(url, {
      method,
      headers: { Authorization: "Bearer " + token },
      body: form
    });

    const out = await res.json();

    if (res.ok) {
      alert(id ? "ìˆ˜ì • ì™„ë£Œ!" : "ë“±ë¡ ì™„ë£Œ!");
      location.href = "/kr/admin/news-list.html";
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (out.message || "ì˜¤ë¥˜"));
    }
  });
</script>

</body>
</html>
