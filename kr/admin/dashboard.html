<!-- /kr/admin/dashboard.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 대시보드 | Fine Defense</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./css/admin.css">

  <!-- 인증 스크립트 -->
  <script src="./js/common_auth.js"></script>

  <!-- 세션 매니저 (공통 세션 관리) -->
  <script type="module" src="/js/session_manager.js"></script>

  <!-- 대시보드 세션 타이머 -->
  <script type="module" src="./js/dashboard_session_timer.js"></script>

</head>

<body>

  <!-- 접근 권한 체크 -->
  <script>
    requireAnyUser();  // 로그인 안했으면 로그인창으로 이동하는 함수
  </script>

  <!-- 사이드바 -->
  <div id="sidebar"></div>

  <!-- 메인 -->
  <div class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="title">관리자 대시보드</div>

      <div style="display:flex; align-items:center; gap:12px;">

        <!-- ⭐ JWT 기반 세션 타이머 -->
        <span id="session-timer" class="session-timer">세션 계산중...</span>

        <!-- 사용자 UI -->
        <div class="topbar-user" id="topbarUser">
          <span id="topbarUserName">관리자</span> ▾
          <div class="user-dropdown" id="userDropdown"></div>
        </div>

        <button onclick="location.href='../index.html'">홈으로</button>
      </div>
    </div>

    <!-- 통계 카드 -->
    <section class="stats-container">
      <div class="stat-card">
        <h3>이번달 조회수</h3>
        <p id="thisMonthViews" class="stat-value">0</p>
      </div>
      <div class="stat-card">
        <h3>지난달 조회수</h3>
        <p id="lastMonthViews" class="stat-value">0</p>
      </div>
      <div class="stat-card">
        <h3>증가율</h3>
        <p id="growthRate" class="stat-value">0%</p>
      </div>
      <div class="stat-card">
        <h3>전체 게시물 수</h3>
        <p id="totalPosts" class="stat-value">0</p>
      </div>
    </section>

    <!-- 월별 그래프 -->
    <section class="panel">
      <h2>월별 조회수 그래프</h2>
      <canvas id="monthlyChart" style="max-height:350px;"></canvas>
    </section>

    <!-- TOP 5 -->
    <section class="panel">
      <h2>조회수 TOP 5 게시물</h2>
      <ul id="topPostsList"></ul>
    </section>

    <!-- 최근 등록 제품 -->
    <section class="panel">
      <h2>최근 등록 제품</h2>
      <div id="recentProducts"></div>
    </section>

  </div>

  <!-- JS -->
  <script src="./js/sidebar.js"></script>
  <script src="./js/dashboard_core.js"></script>

  <script>
    // 사이드바 로드
    loadSidebar("dashboard");

    // 사용자 dropdown 초기화
    (function initTopbarUser() {
      const name = localStorage.getItem("name") || "사용자";
      const role = localStorage.getItem("role");
      const nameSpan = document.getElementById("topbarUserName");
      const dropdown = document.getElementById("userDropdown");
      const userBox = document.getElementById("topbarUser");

      if (nameSpan) nameSpan.textContent = name;

      let html = `<a href="/kr/admin/user_profile.html">내 프로필</a>`;
      if (role === "admin" || role === "superadmin") {
        html += `<a href="/kr/admin/users.html">사용자 관리</a>`;
      }
      html += `<a href="javascript:void(0);" onclick="logout()">로그아웃</a>`;
      dropdown.innerHTML = html;

      userBox.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      });

      document.addEventListener("click", () => {
        dropdown.style.display = "none";
      });
    })();
  </script>

</body>
</html>
