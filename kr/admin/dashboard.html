<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 대시보드 | Fine Defense</title>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fb;
      margin: 0;
    }

    header {
      background: #0f2679;
      color: #fff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { font-size: 1.3rem; }
    header button {
      background: #fff;
      color: #0f2679;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }

    main {
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .upload-form {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .upload-form input,
    .upload-form textarea,
    .upload-form select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    .upload-form button {
      padding: 10px 20px;
      background: #0f2679;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    .post-list {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 20px;
    }

    .post-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .post-item:last-child { border-bottom: none; }

    .delete-btn {
      background: crimson;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /* 썸네일 스타일 */
    #filePreview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
      border: 1px solid #ccc;
      padding: 3px;
    }

    .preview-item {
      position: relative;
      display: inline-block;
    }

    .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: crimson;
      color: #fff;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
    }

  </style>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Fine Defense 관리자 대시보드</h1>
    <button id="logoutBtn">로그아웃</button>
  </header>

  <main>
    <section class="upload-form">
      <h2>게시물 등록</h2>

      <select id="category">
        <option value="news">뉴스룸</option>
        <option value="notice">공지사항</option>
        <option value="gallery">갤러리</option>
      </select>

      <select id="lang">
        <option value="kr">한국어</option>
        <option value="en">English</option>
      </select>

      <input id="title" placeholder="제목" required>

      <div id="editor" style="height: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px;"></div>

      <label for="images"><strong>이미지 업로드 (여러 장 선택 가능)</strong></label>
      <input type="file" id="images" name="images" multiple>

      <div id="filePreview" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        선택된 파일 없음
      </div>

      <button id="uploadBtn">등록</button>
    </section>

    <section class="post-list" id="postList">
      <h2>게시물 목록</h2>
      <div id="posts"></div>
    </section>
  </main>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
    const API_URL = "/api";
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    if (!token || role !== "admin") {
      alert("로그인이 필요합니다.");
      location.href = "/kr/admin/login.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      window.quill = new Quill("#editor", {
        theme: "snow",
        placeholder: "내용을 입력하세요...",
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["link", "image"],
            ["clean"],
          ],
        },
      });
    });

    // ⭐ 누적 파일 저장 배열
    let selectedFiles = [];

    // ⭐ 파일 선택 시 누적 처리
    document.getElementById("images").addEventListener("change", (e) => {
      const newFiles = Array.from(e.target.files);

      selectedFiles.push(...newFiles); // 누적됨

      redrawPreview();
    });

    // ⭐ 미리보기 다시 그리기
    function redrawPreview() {
      const preview = document.getElementById("filePreview");
      preview.innerHTML = "";

      if (selectedFiles.length === 0) {
        preview.textContent = "선택된 파일 없음";
        return;
      }

      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          const wrapper = document.createElement("div");
          wrapper.className = "preview-item";

          const img = document.createElement("img");
          img.src = e.target.result;

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.textContent = "×";
          removeBtn.onclick = () => {
            selectedFiles.splice(index, 1);
            redrawPreview();
          };

          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);

          preview.appendChild(wrapper);
        };

        reader.readAsDataURL(file);
      });
    }

    // ⭐ 게시물 업로드
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const fd = new FormData();

      fd.append("title", document.getElementById("title").value);
      fd.append("content", window.quill.root.innerHTML);
      fd.append("category", document.getElementById("category").value);
      fd.append("lang", document.getElementById("lang").value);

      selectedFiles.forEach(file => {
        fd.append("images", file);
      });

      const res = await fetch(`${API_URL}/posts`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd,
      });

      if (res.ok) {
        alert("등록 완료!");
        selectedFiles = [];
        redrawPreview();
        document.getElementById("title").value = "";
        document.getElementById("images").value = "";
        window.quill.root.innerHTML = "";
        loadPosts();
      } else {
        alert("등록 실패. 서버 로그 확인 필요");
      }
    });

    // 게시물 목록 로드
    async function loadPosts() {
      try {
        const res = await fetch(`${API_URL}/posts/news`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        const posts = await res.json();
        const list = document.getElementById("posts");

        list.innerHTML = posts
          .map(
            (p) => `
              <div class="post-item">
                <div>
                  <strong>${p.title}</strong> (${p.category}) [${p.lang}]
                  <div style="display:flex; gap:6px; margin-top:6px;">
                    ${
                      p.images
                        ? p.images
                            .map(img =>
                              `<img src="${img}" style="width:70px;height:70px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">`
                            )
                            .join("")
                        : ""
                    }
                  </div>
                </div>
                <button class="delete-btn" onclick="deletePost(${p.id})">삭제</button>
              </div>`
          )
          .join("");
      } catch (err) {
        console.error("게시물 로드 실패:", err);
      }
    }

    // 게시물 삭제
    async function deletePost(id) {
      if (!confirm("삭제하시겠습니까?")) return;

      await fetch(`${API_URL}/posts/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });

      loadPosts();
    }

    loadPosts();

    // 로그아웃
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      location.href = "/kr/admin/login.html";
    });
  </script>
</body>
</html>
