<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  const API_URL = "/api";
  const token = localStorage.getItem("token");
  const role = localStorage.getItem("role");

  if (!token || role !== "admin") {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    location.href = "/kr/admin/login.html";
  }

  // Quill Editor ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", () => {
    window.quill = new Quill("#editor", {
      theme: "snow",
      placeholder: "ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”...",
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ["bold", "italic", "underline"],
          [{ list: "ordered" }, { list: "bullet" }],
          ["link", "image"],
          ["clean"],
        ],
      },
    });
  });

  // ==========================================================
  //   ðŸ”¥ ì™„ì „ ì•ˆì •ì ì¸ íŒŒì¼ ëˆ„ì  ë°©ì‹ (input ì™„ì „ ìž¬ìƒì„±)
  // ==========================================================
  let selectedFiles = [];
  let imagesInput = document.getElementById("images");
  const preview = document.getElementById("filePreview");

  function attachInputHandler() {
    const parent = imagesInput.parentNode;

    // ê¸°ì¡´ input ì‚­ì œ
    imagesInput.remove();

    // ìƒˆ input ìƒì„± (ìºì‹œ ì™„ì „ ì´ˆê¸°í™”)
    const newInput = document.createElement("input");
    newInput.type = "file";
    newInput.id = "images";
    newInput.name = "images";
    newInput.multiple = true;

    // DOMì— ì‚½ìž…
    parent.insertBefore(newInput, parent.children[parent.children.length - 1]);
    imagesInput = newInput;

    // change ì´ë²¤íŠ¸ ì—°ê²°
    newInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        selectedFiles.push(...files);
        redrawPreview();
      }

      // ë‹¤ìŒ ì„ íƒë„ ì •ìƒì ìœ¼ë¡œ ìž‘ë™í•˜ë„ë¡ inputì„ ë˜ ìž¬ìƒì„±
      attachInputHandler();
    });
  }

  // ìµœì´ˆ 1íšŒ ì‹¤í–‰
  attachInputHandler();

  // ==========================================================
  // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
  // ==========================================================
  function redrawPreview() {
    preview.innerHTML = "";

    if (selectedFiles.length === 0) {
      preview.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
      return;
    }

    selectedFiles.forEach((file, idx) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const wrap = document.createElement("div");
        wrap.className = "preview-item";

        const img = document.createElement("img");
        img.src = e.target.result;
        img.style.width = "80px";
        img.style.height = "80px";
        img.style.objectFit = "cover";
        img.style.borderRadius = "6px";
        img.style.border = "1px solid #ccc";
        img.style.padding = "3px";

        const btn = document.createElement("button");
        btn.className = "remove-btn";
        btn.textContent = "Ã—";
        btn.onclick = () => {
          selectedFiles.splice(idx, 1);
          redrawPreview();
        };

        wrap.appendChild(img);
        wrap.appendChild(btn);
        preview.appendChild(wrap);
      };
      reader.readAsDataURL(file);
    });
  }

  // ==========================================================
  // ê²Œì‹œë¬¼ ëª©ë¡ ë¡œë“œ
  // ==========================================================
  async function loadPosts() {
    const res = await fetch(`${API_URL}/posts/news`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const posts = await res.json();
    const list = document.getElementById("posts");

    list.innerHTML = posts
      .map(
        (p) => `
        <div class="post-item">
          <div>
            <strong>${p.title}</strong> (${p.category}) [${p.lang}]
            <div style="display:flex; gap:6px; margin-top:6px;">
              ${
                p.images?.length
                  ? p.images
                      .map(
                        (img) =>
                          `<img src="${img}" style="width:70px;height:70px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">`
                      )
                      .join("")
                  : ""
              }
            </div>
          </div>
          <button class="delete-btn" onclick="deletePost(${p.id})">ì‚­ì œ</button>
        </div>`
      )
      .join("");
  }

  async function deletePost(id) {
    if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await fetch(`${API_URL}/posts/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    });
    loadPosts();
  }

  // ==========================================================
  // ê²Œì‹œë¬¼ ì—…ë¡œë“œ
  // ==========================================================
  document.getElementById("uploadBtn").addEventListener("click", async () => {
    if (selectedFiles.length === 0) {
      alert("ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ìž¥ ì´ìƒ ì²¨ë¶€í•˜ì„¸ìš”.");
      return;
    }

    const fd = new FormData();
    fd.append("title", document.getElementById("title").value);
    fd.append("content", window.quill.root.innerHTML);
    fd.append("category", document.getElementById("category").value);
    fd.append("lang", document.getElementById("lang").value);

    selectedFiles.forEach((f) => fd.append("images", f));

    const res = await fetch(`${API_URL}/posts`, {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: fd,
    });

    if (res.ok) {
      alert("ë“±ë¡ ì™„ë£Œ!");
      selectedFiles = [];
      redrawPreview();
      attachInputHandler();
      document.getElementById("title").value = "";
      window.quill.root.innerHTML = "";
      loadPosts();
    } else {
      alert("ë“±ë¡ ì‹¤íŒ¨. ì„œë²„ ë¡œê·¸ í™•ì¸");
    }
  });

  // ë¡œê·¸ì•„ì›ƒ
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    location.href = "/kr/admin/login.html";
  });

  loadPosts();
</script>
