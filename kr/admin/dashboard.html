<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 대시보드 | Fine Defense</title>
  <link rel="stylesheet" href="/css/style.css">

  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background: #f5f7fb; margin: 0; }
    header { background: #0f2679; color: #fff; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 1.3rem; }
    header button { background: #fff; color: #0f2679; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; }
    main { padding: 40px; max-width: 1000px; margin: 0 auto; }
    .upload-form { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 30px; margin-bottom: 40px; }
    .upload-form input, .upload-form textarea, .upload-form select { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; }
    .upload-form button { padding: 10px 20px; background: #0f2679; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    .post-list { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; }
    .post-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
    .post-item:last-child { border-bottom: none; }
    .delete-btn { background: crimson; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; }
    #filePreview { margin-top: 6px; font-size: 14px; color: #333; }
  </style>

  <!-- Quill Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

</head>
<body>
  <header>
    <h1>Fine Defense 관리자 대시보드</h1>
    <button id="logoutBtn">로그아웃</button>
  </header>

  <main>
    <section class="upload-form">
      <h2>게시물 등록</h2>

      <select id="category">
        <option value="news">뉴스룸</option>
        <option value="notice">공지사항</option>
        <option value="gallery">갤러리</option>
      </select>

      <select id="lang">
        <option value="kr">한국어</option>
        <option value="en">English</option>
      </select>

      <input id="title" placeholder="제목" required>

      <div id="editor" style="height: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px;"></div>

      <label for="images"><strong>이미지 업로드 (여러 장 선택 가능)</strong></label>
      <input type="file" id="images" name="images" multiple>

      <!-- ⭐ 파일 선택 미리보기 영역 -->
      <div id="filePreview">선택된 파일 없음</div>

      <button id="uploadBtn">등록</button>
    </section>

    <section class="post-list" id="postList">
      <h2>게시물 목록</h2>
      <div id="posts"></div>
    </section>
  </main>

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
    const API_URL = "/api";
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    // 로그인 확인
    if (!token || role !== "admin") {
      alert("로그인이 필요합니다.");
      location.href = "/kr/admin/login.html";
    }

    // ⭐ Quill Editor 초기화
    document.addEventListener("DOMContentLoaded", () => {
      window.quill = new Quill("#editor", {
        theme: "snow",
        placeholder: "내용을 입력하세요...",
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["link", "image"],
            ["clean"],
          ],
        },
      });
    });

    // ⭐ 파일 선택 프리뷰 기능
    document.getElementById("images").addEventListener("change", () => {
      const files = document.getElementById("images").files;
      const preview = document.getElementById("filePreview");

      if (files.length === 0) {
        preview.textContent = "선택된 파일 없음";
        return;
      }

      let names = [];
      for (const file of files) names.push(file.name);

      preview.textContent = "선택된 파일: " + names.join(", ");
    });

    // 게시물 목록 로드
    async function loadPosts() {
      try {
        const res = await fetch(`${API_URL}/posts/news`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) throw new Error("불러오기 실패");

        const posts = await res.json();
        const list = document.getElementById("posts");

        list.innerHTML = posts
          .map(
            (p) => `
              <div class="post-item">
                <div>
                  <strong>${p.title}</strong> (${p.category}) [${p.lang}]
                  ${
                    p.main_image
                      ? `<img src="${p.main_image}" style="width:80px;margin-left:10px;border-radius:4px;">`
                      : ""
                  }
                </div>
                <button class="delete-btn" onclick="deletePost(${p.id})">삭제</button>
              </div>`
          )
          .join("");
      } catch (err) {
        console.error("게시물 로드 실패:", err);
      }
    }

    // 게시물 삭제
    async function deletePost(id) {
      if (!confirm("삭제하시겠습니까?")) return;

      await fetch(`${API_URL}/posts/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });

      loadPosts();
    }

    // 게시물 업로드
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const fd = new FormData();
      fd.append("title", document.getElementById("title").value);
      fd.append("content", window.quill.root.innerHTML);
      fd.append("category", document.getElementById("category").value);
      fd.append("lang", document.getElementById("lang").value);

      const files = document.getElementById("images").files;
      for (const file of files) fd.append("images", file);

      const res = await fetch(`${API_URL}/posts`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd,
      });

      if (res.ok) {
        alert("등록 완료!");
        document.getElementById("title").value = "";
        document.getElementById("images").value = "";
        document.getElementById("filePreview").textContent = "선택된 파일 없음";
        window.quill.root.innerHTML = "";
        loadPosts();
      } else {
        alert("등록 실패. 서버 로그를 확인하세요.");
      }
    });

    // 로그아웃
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      location.href = "/kr/admin/login.html";
    });

    loadPosts();
  </script>

</body>
</html>
