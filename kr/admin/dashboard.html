<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ | Fine Defense</title>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fb;
      margin: 0;
    }

    header {
      background: #0f2679;
      color: #fff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { font-size: 1.3rem; }
    header button {
      background: #fff;
      color: #0f2679;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }

    main {
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .upload-form {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .upload-form input,
    .upload-form textarea,
    .upload-form select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    .upload-form button {
      padding: 10px 20px;
      background: #0f2679;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    .post-list {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 20px;
    }

    .post-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .post-item:last-child { border-bottom: none; }

    .delete-btn {
      background: crimson;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    #filePreview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
      border: 1px solid #ccc;
      padding: 3px;
    }

    .preview-item {
      position: relative;
      display: inline-block;
    }

    .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: crimson;
      color: #fff;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
    }

  </style>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Fine Defense ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <main>
    <section class="upload-form">
      <h2>ê²Œì‹œë¬¼ ë“±ë¡</h2>

      <select id="category">
        <option value="news">ë‰´ìŠ¤ë£¸</option>
        <option value="notice">ê³µì§€ì‚¬í•­</option>
        <option value="gallery">ê°¤ëŸ¬ë¦¬</option>
      </select>

      <select id="lang">
        <option value="kr">í•œêµ­ì–´</option>
        <option value="en">English</option>
      </select>

      <input id="title" placeholder="ì œëª©" required>

      <div id="editor" style="height: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px;"></div>

      <label for="images"><strong>ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</strong></label>
      <input type="file" id="images" name="images" multiple>

      <div id="filePreview" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        ì„ íƒëœ íŒŒì¼ ì—†ìŒ
      </div>

      <button id="uploadBtn">ë“±ë¡</button>
    </section>

    <section class="post-list" id="postList">
      <h2>ê²Œì‹œë¬¼ ëª©ë¡</h2>
      <div id="posts"></div>
    </section>
  </main>

<script>
  const API_URL = "/api";
  const token = localStorage.getItem("token");
  const role = localStorage.getItem("role");

  if (!token || role !== "admin") {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    location.href = "/kr/admin/login.html";
  }

  // ================================
  //   ğŸ”¥ Quill ì´ˆê¸°í™”
  // ================================
  document.addEventListener("DOMContentLoaded", () => {
    window.quill = new Quill("#editor", {
      theme: "snow",
      placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ["bold", "italic", "underline"],
          [{ list: "ordered" }, { list: "bullet" }],
          ["link", "image"],
          ["clean"],
        ],
      },
    });
  });

  // ================================
  //   ğŸ”¥ ê¸°ì—… ë°©ì‹: input ê´€ë¦¬ êµ¬ì¡° ìˆ˜ì •
  // ================================
  let fileList = [];  
  const hiddenContainer = document.createElement("div");
  hiddenContainer.style.display = "none";
  document.body.appendChild(hiddenContainer);

  const preview = document.getElementById("filePreview");

  function createNewInput() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.multiple = true;

    hiddenContainer.innerHTML = "";
    hiddenContainer.appendChild(input);

    input.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);
      fileList = fileList.concat(files);
      drawPreview();

      // ğŸ”¥ change ì´ë²¤íŠ¸ ë£¨í”„ ë°©ì§€
      input.value = null;

      // ë‹¤ìŒ ì„ íƒ ëŒ€ë¹„ ìƒˆ input ìƒì„±
      inputFile = createNewInput();
    });

    return input;
  }

  // ìµœì´ˆ input
  let inputFile = createNewInput();

  // ================================
  //   ğŸ”¥ #imagesë¥¼ "ë²„íŠ¼" ì²˜ëŸ¼ ì‚¬ìš© (ì°½ ì•ˆëœ¨ê²Œ)
  // ================================
  const visibleInput = document.getElementById("images");
  visibleInput.type = "button";  // â† í•µì‹¬! input:file ì•„ë‹˜
  visibleInput.value = "ì´ë¯¸ì§€ ì„ íƒí•˜ê¸°"; 
  visibleInput.addEventListener("click", () => {
    inputFile.click();   // ìˆ¨ê²¨ì§„ inputì„ í˜¸ì¶œ
  });

  // ================================
  //   ğŸ”¥ ë¯¸ë¦¬ë³´ê¸°
  // ================================
  function drawPreview() {
    preview.innerHTML = "";

    if (fileList.length === 0) {
      preview.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
      return;
    }

    fileList.forEach((file, idx) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const wrap = document.createElement("div");
        wrap.className = "preview-item";

        const img = document.createElement("img");
        img.src = e.target.result;

        const btn = document.createElement("button");
        btn.className = "remove-btn";
        btn.textContent = "Ã—";
        btn.onclick = () => {
          fileList.splice(idx, 1);
          drawPreview();
        };

        wrap.appendChild(img);
        wrap.appendChild(btn);
        preview.appendChild(wrap);
      };

      reader.readAsDataURL(file);
    });
  }

  // ================================
  //   ğŸ”¥ ê²Œì‹œë¬¼ ì—…ë¡œë“œ
  // ================================
  document.getElementById("uploadBtn").addEventListener("click", async () => {
    if (fileList.length === 0) {
      alert("ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ì¥ ì²¨ë¶€í•˜ì„¸ìš”.");
      return;
    }

    const fd = new FormData();
    fd.append("title", document.getElementById("title").value);
    fd.append("content", window.quill.root.innerHTML);
    fd.append("category", document.getElementById("category").value);
    fd.append("lang", document.getElementById("lang").value);

    fileList.forEach((file) => fd.append("images", file));

    const res = await fetch(`${API_URL}/posts`, {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: fd,
    });

    if (!res.ok) {
      alert("ë“±ë¡ ì‹¤íŒ¨ (ì„œë²„í™•ì¸)");
      return;
    }

    alert("ë“±ë¡ ì™„ë£Œ!");

    // ì´ˆê¸°í™”
    fileList = [];
    drawPreview();
    window.quill.root.innerHTML = "";
    document.getElementById("title").value = "";

    inputFile = createNewInput();

    loadPosts();
  });

  // ================================
  //   ğŸ”¥ ê²Œì‹œë¬¼ ëª©ë¡
  // ================================
  async function loadPosts() {
    const res = await fetch(`${API_URL}/posts/news`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    const posts = await res.json();
    const list = document.getElementById("posts");

    list.innerHTML = posts
      .map(
        (p) => `
        <div class="post-item">
          <div>
            <strong>${p.title}</strong> (${p.category}) [${p.lang}]
            <div style="display:flex; gap:6px; margin-top:6px;">
              ${
                p.images?.length
                  ? p.images
                      .map(
                        (img) =>
                          `<img src="${img}" style="width:70px;height:70px;border-radius:6px;border:1px solid #ddd;">`
                      )
                      .join("")
                  : ""
              }
            </div>
          </div>
          <button class="delete-btn" onclick="deletePost(${p.id})">ì‚­ì œ</button>
        </div>
      `
      )
      .join("");
  }

  async function deletePost(id) {
    if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await fetch(`${API_URL}/posts/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    });
    loadPosts();
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    location.href = "/kr/admin/login.html";
  });

  loadPosts();
</script>





</body>
</html>
