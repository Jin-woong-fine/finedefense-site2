<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ | Fine Defense</title>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fb;
      margin: 0;
    }

    header {
      background: #0f2679;
      color: #fff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { font-size: 1.3rem; }
    header button {
      background: #fff;
      color: #0f2679;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }

    main {
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .upload-form {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .upload-form input,
    .upload-form textarea,
    .upload-form select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    .upload-form button {
      padding: 10px 20px;
      background: #0f2679;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    .post-list {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 20px;
    }

    .post-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .post-item:last-child { border-bottom: none; }

    .delete-btn {
      background: crimson;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /* ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ */
    #filePreview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
      border: 1px solid #ccc;
      padding: 3px;
    }

    .preview-item {
      position: relative;
      display: inline-block;
    }

    .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: crimson;
      color: #fff;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
    }

  </style>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Fine Defense ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <main>
    <section class="upload-form">
      <h2>ê²Œì‹œë¬¼ ë“±ë¡</h2>

      <select id="category">
        <option value="news">ë‰´ìŠ¤ë£¸</option>
        <option value="notice">ê³µì§€ì‚¬í•­</option>
        <option value="gallery">ê°¤ëŸ¬ë¦¬</option>
      </select>

      <select id="lang">
        <option value="kr">í•œêµ­ì–´</option>
        <option value="en">English</option>
      </select>

      <input id="title" placeholder="ì œëª©" required>

      <div id="editor" style="height: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px;"></div>

      <label for="images"><strong>ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</strong></label>
      <input type="file" id="images" name="images" multiple>

      <div id="filePreview" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        ì„ íƒëœ íŒŒì¼ ì—†ìŒ
      </div>

      <button id="uploadBtn">ë“±ë¡</button>
    </section>

    <section class="post-list" id="postList">
      <h2>ê²Œì‹œë¬¼ ëª©ë¡</h2>
      <div id="posts"></div>
    </section>
  </main>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
    const API_URL = "/api";
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    // ë¡œê·¸ì¸ í™•ì¸
    if (!token || role !== "admin") {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "/kr/admin/login.html";
    }

    // Quill Editor ì´ˆê¸°í™”
    document.addEventListener("DOMContentLoaded", () => {
      window.quill = new Quill("#editor", {
        theme: "snow",
        placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["link", "image"],
            ["clean"],
          ],
        },
      });
    });

    // âœ… ëˆ„ì ìš© íŒŒì¼ ë°°ì—´
    let selectedFiles = [];

    // âœ… íŒŒì¼ ì„ íƒ ì‹œ ëˆ„ì  + ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
    const imagesInput = document.getElementById("images");
    const preview = document.getElementById("filePreview");

    imagesInput.addEventListener("change", (e) => {
      const input = e.target;
      const newFiles = Array.from(input.files);

      if (!newFiles.length) return;

      // ğŸ”¥ ê¸°ì¡´ ì„ íƒ ìœ ì§€ + ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ ëˆ„ì 
      selectedFiles = selectedFiles.concat(newFiles);

      // ê°™ì€ íŒŒì¼ ë˜ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ì•ˆ ë§‰íˆë„ë¡ value ë¦¬ì…‹
      input.value = "";

      redrawPreview();
    });

    // âœ… ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    function redrawPreview() {
      preview.innerHTML = "";

      if (!selectedFiles.length) {
        preview.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
        return;
      }

      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const wrapper = document.createElement("div");
          wrapper.className = "preview-item";
          wrapper.style.position = "relative";
          wrapper.style.display = "inline-block";
          wrapper.style.marginRight = "8px";

          const img = document.createElement("img");
          img.src = e.target.result;
          img.style.width = "80px";
          img.style.height = "80px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "6px";
          img.style.border = "1px solid #ccc";
          img.style.padding = "3px";

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Ã—";
          removeBtn.className = "remove-btn";
          removeBtn.style.position = "absolute";
          removeBtn.style.top = "-6px";
          removeBtn.style.right = "-6px";
          removeBtn.style.width = "20px";
          removeBtn.style.height = "20px";
          removeBtn.style.borderRadius = "50%";
          removeBtn.style.border = "none";
          removeBtn.style.background = "crimson";
          removeBtn.style.color = "#fff";
          removeBtn.style.cursor = "pointer";
          removeBtn.style.fontSize = "12px";
          removeBtn.onclick = () => {
            // í•´ë‹¹ ì¸ë±ìŠ¤ íŒŒì¼ë§Œ ì œê±°
            selectedFiles.splice(index, 1);
            redrawPreview();
          };

          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          preview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      });
    }

    // âœ… ê²Œì‹œë¬¼ ëª©ë¡ ë¡œë“œ
    async function loadPosts() {
      try {
        const res = await fetch(`${API_URL}/posts/news`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

        const posts = await res.json();
        const list = document.getElementById("posts");

        list.innerHTML = posts
          .map(
            (p) => `
              <div class="post-item">
                <div>
                  <strong>${p.title}</strong> (${p.category}) [${p.lang}]
                  <div style="display:flex; gap:6px; margin-top:6px;">
                    ${
                      p.images && p.images.length > 0
                        ? p.images
                            .map(img =>
                              `<img src="${img}" style="width:70px;height:70px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">`
                            )
                            .join("")
                        : ""
                    }
                  </div>
                </div>
                <button class="delete-btn" onclick="deletePost(${p.id})">ì‚­ì œ</button>
              </div>`
          )
          .join("");
      } catch (err) {
        console.error("ê²Œì‹œë¬¼ ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    }

    // âœ… ê²Œì‹œë¬¼ ì‚­ì œ
    async function deletePost(id) {
      if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      await fetch(`${API_URL}/posts/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });

      loadPosts();
    }

    // âœ… ê²Œì‹œë¬¼ ì—…ë¡œë“œ
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      if (!selectedFiles.length) {
        alert("ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ì¥ ì´ìƒ ì²¨ë¶€í•˜ì„¸ìš”.");
        return;
      }

      const fd = new FormData();
      fd.append("title", document.getElementById("title").value);
      fd.append("content", window.quill.root.innerHTML);
      fd.append("category", document.getElementById("category").value);
      fd.append("lang", document.getElementById("lang").value);

      selectedFiles.forEach(file => {
        fd.append("images", file);
      });

      const res = await fetch(`${API_URL}/posts`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd,
      });

      if (res.ok) {
        alert("ë“±ë¡ ì™„ë£Œ!");
        // ì—…ë¡œë“œ í›„ ì´ˆê¸°í™”
        selectedFiles = [];
        redrawPreview();
        document.getElementById("title").value = "";
        imagesInput.value = "";
        window.quill.root.innerHTML = "";
        loadPosts();
      } else {
        alert("ë“±ë¡ ì‹¤íŒ¨. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      }
    });

    // âœ… ë¡œê·¸ì•„ì›ƒ
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      location.href = "/kr/admin/login.html";
    });

    loadPosts();
  </script>

</body>
</html>
