<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ì‚¬í•­ ìˆ˜ì • | Fine Defense ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="./css/admin.css">

  <style>
    .file-item {
      background: #f5f5f5;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .remove-old-btn {
      background: crimson;
      color: white;
      border: none;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .panel h2 { margin-top: 0; }

    .help-text {
      font-size: 0.8rem;
      color: #777;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<div id="sidebar" data-active="notice"></div>

<div class="main">

  <div class="topbar">
    <h2>ê³µì§€ì‚¬í•­ ìˆ˜ì •</h2>
    <div>
      <button class="btn btn-primary" onclick="location.href='./notice-list.html'">ëª©ë¡ìœ¼ë¡œ</button>
      <button id="logoutBtn" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <form id="noticeForm" enctype="multipart/form-data">

    <!-- ğŸ“Œ ê³µì§€ ì •ë³´ -->
    <section class="panel">
      <h2>ê³µì§€ ì •ë³´ ìˆ˜ì •</h2>

      <input id="title" class="input" placeholder="ê³µì§€ ì œëª©" />

      <select id="lang" class="input">
        <option value="kr">í•œêµ­ì–´</option>
        <option value="en">English</option>
      </select>

      <!-- ğŸ”¢ ì •ë ¬ ìˆœë²ˆ -->
      <input
        id="sort_order"
        class="input"
        type="number"
        placeholder="ì •ë ¬ ìˆœë²ˆ (ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ìƒë‹¨ì— ë…¸ì¶œ)"
        min="1"
      />
      <div class="help-text">
        * ë©”ì¸ ê³µì§€ì²˜ëŸ¼ ìœ„ì— ê³ ì •í•˜ê³  ì‹¶ì€ ê¸€ì€ ì‘ì€ ìˆ«ì(ì˜ˆ: 1, 2, 3)ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ë¯¸ì„¤ì • ì‹œ ê¸°ë³¸ê°’ 9999.
      </div>

      <h3 style="margin-top:20px;">ê³µì§€ ë‚´ìš©</h3>
      <div id="editor" style="border:1px solid #ccc;border-radius:6px;"></div>
    </section>

    <!-- ğŸ“ ì²¨ë¶€íŒŒì¼ -->
    <section class="panel">
      <h3>ê¸°ì¡´ ì²¨ë¶€íŒŒì¼</h3>
      <div id="oldFiles"></div>
      <div class="help-text">
        * ì²´í¬í•œ íŒŒì¼ë§Œ ì‚­ì œë©ë‹ˆë‹¤. ì‚­ì œí•˜ì§€ ì•Šì€ ì²¨ë¶€íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
      </div>

      <h3 style="margin-top:20px;">ìƒˆ ì²¨ë¶€íŒŒì¼ ì¶”ê°€</h3>
      <input type="file" id="newFiles" name="files" multiple class="input">
      <div id="newFilePreview" class="file-list"></div>

      <button type="submit" class="btn btn-primary" style="margin-top:15px;">
        ìˆ˜ì • ì™„ë£Œ
      </button>
    </section>

  </form>
</div>

<!-- ê³µí†µ JS -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>

<!-- Toast UI -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  let editor;
  let noticeId;
  let oldFileList = [];    // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ [{id, file_path, original_name}, ... ì˜ˆìƒ]
  let removeOldFiles = []; // ì‚­ì œí•  íŒŒì¼ ê²½ë¡œ(or id) ëª©ë¡

  /* ===========================================================
      ğŸ” ê¶Œí•œ + ì´ˆê¸° ì„¤ì •
  ============================================================ */
  (function () {
    requireAdminOrEditor();
    document.getElementById("logoutBtn").addEventListener("click", logout);

    const urlParams = new URLSearchParams(location.search);
    noticeId = urlParams.get("id");
    if (!noticeId) {
      alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
      location.href = "./notice-list.html";
      return;
    }

    loadNotice();
  })();


  /* ===========================================================
      âœï¸ Toast UI Editor ì´ˆê¸°í™”
  ============================================================ */
  function initEditor(content) {
    editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      initialValue: content || "",
      hideModeSwitch: true,
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol'],
        ['table', 'link']
        // ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ì‚¬ìš© ì•ˆ í•˜ë¯€ë¡œ image ë²„íŠ¼ ì œê±°
      ]
    });
  }


  /* ===========================================================
      ğŸ“Œ ê¸°ì¡´ ë°ì´í„° ë¡œë”©
  ============================================================ */
  async function loadNotice() {
    try {
      const res = await fetch(`/api/posts/detail/${noticeId}`);
      if (!res.ok) throw new Error("ê³µì§€ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

      const data = await res.json();

      document.getElementById("title").value = data.title || "";
      document.getElementById("lang").value  = data.lang || "kr";
      document.getElementById("sort_order").value =
        (data.sort_order !== null && data.sort_order !== undefined)
          ? data.sort_order
          : "";

      initEditor(data.content || "");

      // ê¸°ì¡´ ì²¨ë¶€íŒŒì¼
      oldFileList = Array.isArray(data.files) ? data.files : [];
      renderOldFiles();

    } catch (e) {
      console.error(e);
      alert("ê³µì§€ì‚¬í•­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      location.href = "./notice-list.html";
    }
  }


  /* ===========================================================
      ğŸ“ ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ UI ë Œë”ë§
  ============================================================ */
  function renderOldFiles() {
    const wrap = document.getElementById("oldFiles");

    if (!oldFileList.length) {
      wrap.innerHTML = "<div style='color:#777;'>ì²¨ë¶€íŒŒì¼ ì—†ìŒ</div>";
      return;
    }

    wrap.innerHTML = oldFileList.map((f, i) => `
      <div class="file-item">
        <a href="${f.file_path}" target="_blank">${f.original_name}</a>
        <button type="button" class="remove-old-btn" onclick="markFileForDelete(${i})">ì‚­ì œ</button>
      </div>
    `).join("");
  }

  // ğŸ”¥ ì‚­ì œí•  íŒŒì¼ í‘œì‹œ (í™”ë©´ì—ì„œ ì œê±° + ì‚­ì œëª©ë¡ì— ì¶”ê°€)
  function markFileForDelete(index) {
    const file = oldFileList[index];
    if (!file) return;

    // ì—¬ê¸°ì„œëŠ” file_path ê¸°ì¤€ìœ¼ë¡œ ì‚­ì œ ëª©ë¡ì„ ì„œë²„ì— ì „ë‹¬
    removeOldFiles.push(file.file_path);

    // í™”ë©´ì—ì„œ ì œê±°
    oldFileList.splice(index, 1);
    renderOldFiles();
  }


  /* ===========================================================
      ğŸ“ ìƒˆ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
  ============================================================ */
  const newFilesInput = document.getElementById("newFiles");
  const newPreview = document.getElementById("newFilePreview");

  newFilesInput.addEventListener("change", (e) => {
    const files = [...e.target.files];
    if (!files.length) {
      newPreview.innerHTML = "";
      return;
    }

    newPreview.innerHTML = files
      .map(f => `<div class="file-item">${f.name}</div>`)
      .join("");
  });


  /* ===========================================================
      ğŸš€ ê³µì§€ ìˆ˜ì • ìš”ì²­
  ============================================================ */
  document.getElementById("noticeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value.trim();
    const lang = document.getElementById("lang").value;
    const sortOrderRaw = document.getElementById("sort_order").value;
    const sortOrder = sortOrderRaw === "" ? 9999 : Number(sortOrderRaw);
    const content = editor.getHTML();
    const newFiles = document.getElementById("newFiles").files;

    if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
    if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

    const formData = new FormData();
    formData.append("title", title);
    formData.append("content", content);
    formData.append("lang", lang);
    formData.append("sort_order", isNaN(sortOrder) ? 9999 : sortOrder);

    // ğŸ—‘ ì‚­ì œí•  ê¸°ì¡´ íŒŒì¼ ëª©ë¡ (JSON ë¬¸ìì—´ë¡œ ì „ì†¡)
    formData.append("removeFiles", JSON.stringify(removeOldFiles));

    // ğŸ†• ìƒˆ íŒŒì¼ ì¶”ê°€
    [...newFiles].forEach(f => formData.append("files", f));

    const token = localStorage.getItem("token");

    try {
      const res = await fetch(`/api/posts/notice/update/${noticeId}`, {
        method: "PUT",
        headers: { Authorization: `Bearer ${token}` },
        body: formData
      });

      const result = await res.json();

      if (res.ok) {
        alert("ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.href = "./notice-list.html";
      } else {
        console.error(result);
        alert("ìˆ˜ì • ì‹¤íŒ¨: " + (result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    } catch (err) {
      console.error(err);
      alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });

</script>

</body>
</html>
