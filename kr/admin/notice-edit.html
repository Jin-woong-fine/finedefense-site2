<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공지사항 수정 | Fine Defense Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- 공통 관리자 CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css">
</head>

<body data-admin-page="notice">

<!-- 인증 -->
<script src="/kr/admin/js/common_auth.js"></script>
<script>
  requireAdminOrEditor();
</script>

<!-- =========================================================
     ADMIN LAYOUT (DASHBOARD SAME)
========================================================= -->
<div class="admin-wrapper">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="admin-sidebar"></aside>

  <!-- CONTENT -->
  <div class="admin-content">
    <div class="main">

      <!-- ✅ TOPBAR (공통 컴포넌트) -->
      <div id="topbar"></div>

      <!-- =================================================
           FORM
      ================================================== -->
      <form id="noticeForm" enctype="multipart/form-data">

        <!-- 공지 정보 -->
        <section class="panel">
          <h2>공지 정보 수정</h2>

          <input id="title" class="search-input" placeholder="공지 제목" />

          <select id="lang" class="search-input">
            <option value="kr">한국어</option>
            <option value="en">English</option>
          </select>

          <input
            id="sort_order"
            class="search-input"
            type="number"
            placeholder="정렬 순번 (기본 9999)"
            min="1"
          />

          <div class="help-text">
            • 상단 고정: 낮은 숫자 (1,2,3)<br>
            • 미입력 시 자동으로 9999
          </div>

          <h2 style="margin-top:24px;">공지 내용</h2>
          <div id="editor"></div>
        </section>

        <!-- 첨부파일 -->
        <section class="panel">
          <h2>첨부파일</h2>

          <h3>기존 파일</h3>
          <div id="oldFiles"></div>

          <h3 style="margin-top:20px;">새 파일 추가</h3>
          <input
            type="file"
            id="newFiles"
            name="files"
            multiple
            class="search-input"
          />

          <div id="newFilePreview"></div>

          <div style="margin-top:24px;">
            <button type="submit" class="btn-primary">
              수정 완료
            </button>
          </div>
        </section>

      </form>

    </div>
  </div>
</div>

<!-- =========================================================
     SCRIPTS
========================================================= -->
<script src="/kr/admin/js/sidebar.js"></script>
<script src="/kr/admin/js/topbar.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  let editor;
  let noticeId;
  let oldFileList = [];
  let removeOldFiles = [];

  document.addEventListener("DOMContentLoaded", () => {
    loadSidebar("notice");

    const params = new URLSearchParams(location.search);
    noticeId = params.get("id");

    if (!noticeId) {
      alert("잘못된 접근입니다.");
      location.href = "./notice-list.html";
      return;
    }

    loadNotice();
  });

  function initEditor(content) {
    editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      initialValue: content,
      hideModeSwitch: true,
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol'],
        ['table', 'link']
      ]
    });
  }

  async function loadNotice() {
    const res = await fetch(`/api/posts/detail/${noticeId}`);
    const data = await res.json();

    title.value = data.title;
    lang.value = data.lang;
    sort_order.value = data.sort_order ?? "";

    initEditor(data.content);

    oldFileList = Array.isArray(data.files) ? data.files : [];
    renderOldFiles();
  }

  function renderOldFiles() {
    const wrap = document.getElementById("oldFiles");

    if (!oldFileList.length) {
      wrap.innerHTML = "<div style='color:#777;'>첨부파일 없음</div>";
      return;
    }

    wrap.innerHTML = oldFileList.map((f, i) => `
      <div class="file-item">
        <a href="${f.file_path}" target="_blank">${f.original_name}</a>
        <button type="button" class="btn-small btn-danger"
          onclick="markFileForDelete(${i})">삭제</button>
      </div>
    `).join("");
  }

  function markFileForDelete(index) {
    removeOldFiles.push(oldFileList[index].file_path);
    oldFileList.splice(index, 1);
    renderOldFiles();
  }

  newFiles.addEventListener("change", (e) => {
    newFilePreview.innerHTML =
      [...e.target.files].map(f => `<div class="file-item">${f.name}</div>`).join("");
  });

  noticeForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append("title", title.value);
    formData.append("content", editor.getHTML());
    formData.append("lang", lang.value);
    formData.append("sort_order", sort_order.value || 9999);
    formData.append("removeFiles", JSON.stringify(removeOldFiles));

    [...newFiles.files].forEach(f => formData.append("files", f));

    const res = await fetch(`/api/posts/notice/update/${noticeId}`, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token")
      },
      body: formData
    });

    if (res.ok) {
      alert("공지사항이 수정되었습니다.");
      location.href = "./notice-list.html";
    } else {
      const out = await res.json();
      alert("수정 실패: " + (out.message || "오류"));
    }
  });
</script>

</body>
</html>
