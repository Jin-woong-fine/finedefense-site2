<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공지사항 수정 | Fine Defense 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Toast UI Editor CSS -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- 공통 관리자 CSS -->
  <link rel="stylesheet" href="./css/admin.css">

  <style>
    .panel h2 { margin-top: 0; }
    .file-list { margin-top: 10px; }
    .file-item {
      margin-bottom: 6px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      background: #f4f4f4;
      padding: 8px;
      border-radius: 6px;
    }
    .file-item span.label {
      color:#555;
    }
  </style>
</head>

<body>

<div id="sidebar" data-active="notice"></div>

<div class="main">

  <div class="topbar">
    <h2>공지사항 수정</h2>
    <div>
      <button class="btn btn-primary" onclick="location.href='./notice-list.html'">목록으로</button>
      <button id="logoutBtn" class="btn btn-danger">로그아웃</button>
    </div>
  </div>

  <form id="noticeForm" enctype="multipart/form-data">

    <section class="panel">
      <h2>공지 정보 수정</h2>

      <input id="title" class="input" placeholder="공지 제목" />

      <select id="lang" class="input">
        <option value="kr">한국어</option>
        <option value="en">English</option>
      </select>

      <h3>공지 내용</h3>
      <div id="editor" style="border:1px solid #ccc;border-radius:6px;"></div>
    </section>

    <section class="panel">
      <h3>첨부파일</h3>

      <div id="currentFiles" class="file-list" style="margin-bottom:10px;"></div>

      <p style="font-size:0.9rem;color:#777;">
        새로운 파일을 업로드하면 기존 첨부파일은 모두 교체됩니다.
      </p>

      <input
        type="file"
        id="files"
        name="files"
        multiple
        class="input"
      />

      <div id="filePreview" class="file-list"></div>

      <button type="submit" class="btn btn-primary" style="margin-top:15px;">
        수정 완료
      </button>
    </section>

  </form>

</div>

<!-- 공통 JS -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>

<!-- Toast UI Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  (function () {
    requireAdminOrEditor();
    document.getElementById("logoutBtn").addEventListener("click", logout);
  })();

  const params = new URLSearchParams(location.search);
  const noticeId = params.get("id");
  if (!noticeId) {
    alert("잘못된 접근입니다. ID가 없습니다.");
    location.href = "./notice-list.html";
  }

  let editor; // 전역으로

  // Toast Editor 초기화 + 데이터 로드
  async function initPage() {
    editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical'
    });

    try {
      const res = await fetch(`/api/posts/detail/${noticeId}`);
      if (!res.ok) throw new Error("공지 불러오기 실패");
      const data = await res.json();

      document.getElementById("title").value = data.title || "";
      document.getElementById("lang").value = data.lang || "kr";
      editor.setHTML(data.content || "");

      const currentFiles = data.files || [];
      const curBox = document.getElementById("currentFiles");
      if (!currentFiles.length) {
        curBox.innerHTML = `<div class="file-item"><span class="label">등록된 첨부파일이 없습니다.</span></div>`;
      } else {
        curBox.innerHTML = currentFiles.map(f => `
          <div class="file-item">
            <span class="label">${f.original_name || f.file_path}</span>
          </div>
        `).join("");
      }

    } catch (e) {
      console.error(e);
      alert("공지 정보를 불러오는 중 오류가 발생했습니다.");
      location.href = "./notice-list.html";
    }
  }

  initPage();

  // 새 첨부 미리보기
  const fileInput = document.getElementById("files");
  const filePreview = document.getElementById("filePreview");

  fileInput.addEventListener("change", (e) => {
    const files = [...e.target.files];
    if (!files.length) {
      filePreview.innerHTML = "";
      return;
    }
    filePreview.innerHTML = files
      .map(f => `<div class="file-item">${f.name}</div>`)
      .join("");
  });

  // 수정 요청
  document.getElementById("noticeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value.trim();
    const lang = document.getElementById("lang").value;
    const content = editor.getHTML();
    const files = document.getElementById("files").files;

    if (!title) return alert("제목을 입력하세요.");
    if (!content) return alert("내용을 입력하세요.");

    const formData = new FormData();
    formData.append("title", title);
    formData.append("content", content);
    formData.append("lang", lang);

    [...files].forEach(f => formData.append("files", f));

    const token = localStorage.getItem("token");

    const res = await fetch(`/api/posts/notice/update/${noticeId}`, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();

    if (res.ok) {
      alert("수정이 완료되었습니다.");
      location.href = "./notice-list.html";
    } else {
      console.error(result);
      alert("수정 실패: " + (result.message || "알 수 없는 오류"));
    }
  });
</script>

</body>
</html>
