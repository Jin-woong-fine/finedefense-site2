<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ì‚¬í•­ ìˆ˜ì • | Fine Defense Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css">
</head>

<body data-admin-page="notice">

<!-- ì¸ì¦ -->
<script src="/kr/admin/js/common_auth.js"></script>
<script>
  requireAdminOrEditor();
</script>

<!-- =========================================================
     ADMIN LAYOUT
========================================================= -->
<div class="admin-wrapper">

  <!-- ===================== SIDEBAR ====================== -->
  <aside id="sidebar" class="admin-sidebar"></aside>

  <!-- ===================== CONTENT ====================== -->
  <div class="admin-content">
    <div class="main">

      <!-- ===================== TOPBAR ====================== -->
      <div class="topbar">
        <div class="title">ê³µì§€ì‚¬í•­ ìˆ˜ì •</div>

        <div class="topbar-right">
          <button id="topbarUser" class="topbar-user" type="button">
            <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
          </button>

          <div id="userDropdown" class="user-dropdown">
            <button class="dropdown-item" data-action="logout" type="button">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>

          <button type="button" onclick="location.href='./notice-list.html'">
            ëª©ë¡ìœ¼ë¡œ
          </button>
        </div>
      </div>

      <!-- ===================== FORM ====================== -->
      <form id="noticeForm" enctype="multipart/form-data">

        <!-- ğŸ”¹ ê³µì§€ ì •ë³´ -->
        <section class="panel">
          <h2>ê³µì§€ ì •ë³´ ìˆ˜ì •</h2>

          <input id="title" class="search-input" placeholder="ê³µì§€ ì œëª©" />

          <select id="lang" class="search-input">
            <option value="kr">í•œêµ­ì–´</option>
            <option value="en">English</option>
          </select>

          <input
            id="sort_order"
            class="search-input"
            type="number"
            placeholder="ì •ë ¬ ìˆœë²ˆ (ê¸°ë³¸ 9999)"
            min="1"
          />

          <div class="help-text">
            â€¢ ìƒë‹¨ ê³ ì •: ë‚®ì€ ìˆ«ì (1,2,3)<br>
            â€¢ ë¯¸ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ 9999
          </div>

          <h2 style="margin-top:24px;">ê³µì§€ ë‚´ìš©</h2>
          <div id="editor"></div>
        </section>

        <!-- ğŸ”¹ ì²¨ë¶€íŒŒì¼ -->
        <section class="panel">
          <h2>ì²¨ë¶€íŒŒì¼</h2>

          <h3>ê¸°ì¡´ íŒŒì¼</h3>
          <div id="oldFiles"></div>

          <h3 style="margin-top:20px;">ìƒˆ íŒŒì¼ ì¶”ê°€</h3>
          <input
            type="file"
            id="newFiles"
            name="files"
            multiple
            class="search-input"
          />

          <div id="newFilePreview"></div>

          <div style="margin-top:24px;">
            <button type="submit" class="btn-primary">
              ìˆ˜ì • ì™„ë£Œ
            </button>
          </div>
        </section>

      </form>

    </div>
  </div>
</div>

<!-- =========================================================
     SCRIPTS
========================================================= -->
<script src="/kr/admin/js/sidebar.js"></script>
<script src="/kr/admin/js/topbar.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  let editor;
  let noticeId;
  let oldFileList = [];
  let removeOldFiles = [];

  document.addEventListener("DOMContentLoaded", () => {
    loadSidebar("notice");

    const params = new URLSearchParams(location.search);
    noticeId = params.get("id");

    if (!noticeId) {
      alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
      location.href = "./notice-list.html";
      return;
    }

    loadNotice();
  });

  function initEditor(content) {
    editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      initialValue: content,
      hideModeSwitch: true,
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol'],
        ['table', 'link']
      ]
    });
  }

  async function loadNotice() {
    const res = await fetch(`/api/posts/detail/${noticeId}`);
    const data = await res.json();

    document.getElementById("title").value = data.title;
    document.getElementById("lang").value = data.lang;
    document.getElementById("sort_order").value = data.sort_order ?? "";

    initEditor(data.content);

    oldFileList = Array.isArray(data.files) ? data.files : [];
    renderOldFiles();
  }

  function renderOldFiles() {
    const wrap = document.getElementById("oldFiles");

    if (!oldFileList.length) {
      wrap.innerHTML = "<div style='color:#777;'>ì²¨ë¶€íŒŒì¼ ì—†ìŒ</div>";
      return;
    }

    wrap.innerHTML = oldFileList.map((f, i) => `
      <div class="file-item">
        <a href="${f.file_path}" target="_blank">${f.original_name}</a>
        <button type="button" class="btn-small btn-danger"
          onclick="markFileForDelete(${i})">ì‚­ì œ</button>
      </div>
    `).join("");
  }

  function markFileForDelete(index) {
    const file = oldFileList[index];
    removeOldFiles.push(file.file_path);
    oldFileList.splice(index, 1);
    renderOldFiles();
  }

  document.getElementById("newFiles").addEventListener("change", (e) => {
    const files = [...e.target.files];
    document.getElementById("newFilePreview").innerHTML =
      files.map(f => `<div class="file-item">${f.name}</div>`).join("");
  });

  document.getElementById("noticeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append("title", title.value);
    formData.append("content", editor.getHTML());
    formData.append("lang", lang.value);
    formData.append("sort_order", sort_order.value || 9999);
    formData.append("removeFiles", JSON.stringify(removeOldFiles));

    [...newFiles.files].forEach(f => formData.append("files", f));

    const res = await fetch(`/api/posts/notice/update/${noticeId}`, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token")
      },
      body: formData
    });

    if (res.ok) {
      alert("ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "./notice-list.html";
    } else {
      const out = await res.json();
      alert("ìˆ˜ì • ì‹¤íŒ¨: " + (out.message || "ì˜¤ë¥˜"));
    }
  });
</script>

</body>
</html>
