<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>일별 트래픽 분석 | Fine Defense Admin</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="./css/admin.css" />

  <!-- 인증 / 공통 -->
  <script src="./js/common_auth.js"></script>

  <!-- 세션 -->
  <script type="module" src="/js/session_manager.js"></script>
  <script type="module" src="./js/dashboard_session_timer.js"></script>

  <style>
    /* KPI */
    .kpi-row{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:16px;
      margin-bottom:24px;
    }


    .kpi-card{
      background:#fff;
      border-radius:14px;
      padding:18px 20px;
      box-shadow:0 4px 14px rgba(15,38,121,0.08);
    }
    .kpi-card span{
      font-size:0.85rem;
      color:#6b7280;
    }
    .kpi-card strong{
      display:block;
      margin-top:6px;
      font-size:1.8rem;
      font-weight:700;
      color:#0f2679;
      letter-spacing:-0.02em;
    }
  </style>
</head>

<body data-admin-page="traffic_daily">
<script>requireAnyUser();</script>

<div id="sidebar"></div>

<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="title">일별 트래픽 분석</div>
    <div style="display:flex; align-items:center; gap:12px;">
      <span id="session-timer" class="session-timer"></span>
      <div class="topbar-user" id="topbarUser">
        <span id="topbarUserName">관리자</span> ▾
        <div class="user-dropdown" id="userDropdown"></div>
      </div>
      <button onclick="location.href='../index.html'">홈으로</button>
    </div>
  </div>

  <!-- KPI -->
  <section class="kpi-row">
    <!-- UV -->
    <div class="kpi-card"><span>오늘 방문자 (UV)</span><strong id="kpiUvToday">0</strong></div>
    <div class="kpi-card"><span>7일 평균 UV</span><strong id="kpiUvAvg7">0</strong></div>
    <div class="kpi-card"><span>30일 UV 누적</span><strong id="kpiUvSum30">0</strong></div>

    <!-- PV -->
    <div class="kpi-card"><span>오늘 페이지뷰 (PV)</span><strong id="kpiPvToday">0</strong></div>
    <div class="kpi-card"><span>7일 평균 PV</span><strong id="kpiPvAvg7">0</strong></div>
    <div class="kpi-card"><span>30일 PV 누적</span><strong id="kpiPvSum30">0</strong></div>
  </section>

  <!-- UV Chart -->
  <section class="panel">
    <h2 style="margin-bottom:12px;">방문자 추이 (UV)</h2>
    <canvas id="uvChart"></canvas>
  </section>

  <!-- PV Chart -->
  <section class="panel">
    <h2 style="margin-bottom:12px;">페이지뷰 추이 (PV)</h2>
    <canvas id="pvChart"></canvas>
  </section>

</div>

<script src="/kr/admin/js/common_auth.js"></script>
<script src="./js/sidebar.js"></script>
<script src="./js/topbar_user_menu.js"></script>

<script>
requireLogin()	


/* =========================================================
   DAILY TRAFFIC — UV / PV
   API: /api/traffic/daily?days=30
   response: { day, uv, pv }
========================================================= */

let uvChart, pvChart;
const DAYS = 30;

async function loadTraffic(){
  try{
    const res = await fetch(`/api/traffic/daily?days=${DAYS}`);
    const data = await res.json();
    if(!Array.isArray(data)) return;

    const rows = [...data].reverse(); // ASC
    const labels = rows.map(r => r.day);
    const uv = rows.map(r => Number(r.uv||0));
    const pv = rows.map(r => Number(r.pv||0));

    updateKPI(uv, pv);
    renderUv(labels, uv);
    renderPv(labels, pv);

  }catch(e){
    console.error(e);
  }
}

/* KPI */
function updateKPI(uv, pv){
  set("kpiUvToday", uv.at(-1));
  set("kpiPvToday", pv.at(-1));
  set("kpiUvAvg7", avg(uv,7));
  set("kpiPvAvg7", avg(pv,7));
  set("kpiUvSum30", sum(uv,30));
  set("kpiPvSum30", sum(pv,30));
}

function set(id,v){ document.getElementById(id).textContent=(v||0).toLocaleString(); }
function sum(a,n){ return a.slice(-n).reduce((x,y)=>x+y,0); }
function avg(a,n){
  const s=a.slice(-Math.min(n,a.length));
  return s.length?Math.round(s.reduce((x,y)=>x+y,0)/s.length):0;
}

/* Charts */
function renderUv(labels, values){
  if(uvChart) uvChart.destroy();
  uvChart=new Chart(uvChartEl(), lineCfg(labels, values, "방문자 수", "#0f2679"));
}
function renderPv(labels, values){
  if(pvChart) pvChart.destroy();
  pvChart=new Chart(pvChartEl(), lineCfg(labels, values, "페이지뷰 수", "#2563eb"));
}
function uvChartEl(){ return document.getElementById("uvChart"); }
function pvChartEl(){ return document.getElementById("pvChart"); }

function lineCfg(labels, values, title, color){
  return {
    type:"line",
    data:{ labels,
      datasets:[{ data:values, borderColor:color,
        backgroundColor:color+"14", fill:true, tension:.3, pointRadius:2 }]
    },
    options:{
      plugins:{ legend:{display:false},
        tooltip:{callbacks:{label:c=>`${title}: ${c.raw.toLocaleString()}`}}
      },
      scales:{ y:{beginAtZero:true} }
    }
  };
}

/* init */
loadSidebar("traffic_daily");
loadTraffic();
</script>

</body>
</html>
