<!-- /kr/admin/gallery-edit.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê°¤ëŸ¬ë¦¬ ì‘ì„±/ìˆ˜ì • | Fine Defense Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css" />

  <style>
    .form-box {
      background:#fff;
      padding:25px 30px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      max-width:900px;
      margin:30px auto 60px;
    }

    .form-box label {
      display:block;
      margin:14px 0 6px;
      font-weight:600;
    }

    .form-box input[type="text"],
    .form-box select {
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:0.95rem;
      box-sizing:border-box;
    }

    .preview-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }

    .preview-item img {
      width:120px;
      height:80px;
      object-fit:cover;
      border-radius:8px;
      border:1px solid #ddd;
    }

    .preview-label {
      font-size:0.8rem;
      color:#666;
      margin-top:3px;
      text-align:center;
    }

    .btn-row {
      margin-top:24px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    /* âœ… ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ ë²„íŠ¼ + ë“œë˜ê·¸ í‘œì‹œ */
    .preview-item{
      position:relative;
      user-select:none;
    }
    .img-delete-btn{
      position:absolute;
      top:6px;
      right:6px;
      width:22px;
      height:22px;
      border:none;
      border-radius:50%;
      background:rgba(0,0,0,0.65);
      color:#fff;
      cursor:pointer;
      font-size:13px;
      line-height:22px;
      text-align:center;
    }
    .preview-item.dragging{
      opacity:0.55;
    }
    .preview-item.drag-over{
      outline:2px dashed #0f2679;
      outline-offset:4px;
    }



  </style>
</head>

<body>

<div id="sidebar" data-active="gallery"></div>

<div class="main">

  <!-- ğŸ”µ TOPBAR -->
  <div class="topbar">
    <div class="title">ê°¤ëŸ¬ë¦¬ ì‘ì„± ë° ìˆ˜ì •</div>

    <div style="display:flex; align-items:center; gap:12px;">

      <!-- â­ ì„¸ì…˜ íƒ€ì´ë¨¸ -->
      <span id="session-timer" class="session-timer">ì„¸ì…˜ ê³„ì‚°ì¤‘...</span>

      <div class="topbar-user" id="topbarUser">
        <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
        <div class="user-dropdown" id="userDropdown"></div>
      </div>

      <button onclick="location.href='../index.html'">í™ˆìœ¼ë¡œ</button>
    </div>
  </div>

  <div class="form-box">
    <label>ì–¸ì–´</label>
    <select id="lang">
      <option value="kr">KR</option>
      <option value="en">EN</option>
    </select>

    <label>ì œëª© <span style="color:#c00;">*</span></label>
    <input id="title" type="text" placeholder="ê°¤ëŸ¬ë¦¬ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.">

    <label>ëŒ€í‘œ ì´ë¯¸ì§€ (ì¸ë„¤ì¼)</label>
    <input id="cover" type="file" accept="image/*">
    <div id="coverPreview" class="preview-row"></div>

    <label>ì¶”ê°€ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ ê°€ëŠ¥)</label>
    <input id="images" type="file" accept="image/*" multiple>
    <div id="imagesPreview" class="preview-row"></div>

    <label>ì„¤ëª… (ì„ íƒ)</label>
    <div id="editor" style="margin-top:8px;"></div>

    <div class="btn-row">
      <button class="btn btn-gray" onclick="location.href='gallery-list.html'">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveGallery()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  requireEditPermission()
  // =====================================================
  // ğŸ” ê¶Œí•œ & ì‚¬ì´ë“œë°”
  // =====================================================
  requireAdminOrEditor();
  loadSidebar("gallery");

  const urlParams = new URLSearchParams(location.search);
  const galleryId = urlParams.get("id");

  // =====================================================
  // ğŸ“ Toast UI Editor
  // =====================================================
  const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '400px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    initialValue: ''
  });

  // =====================================================
  // ğŸ§  ìƒíƒœê°’
  // =====================================================
  let existingImages = [];          // í˜„ì¬ ìœ ì§€/ì •ë ¬ëœ "ê¸°ì¡´ ì´ë¯¸ì§€" ë°°ì—´
  let originalExistingImages = [];  // ìµœì´ˆ ë¡œë“œëœ ì´ë¯¸ì§€(ì‚­ì œ íŒë³„ìš©)

  // =====================================================
  // ğŸ–¼ï¸ ìƒˆ ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°(ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
  // =====================================================
  function createPreview(containerId, files) {
    const box = document.getElementById(containerId);
    box.innerHTML = "";

    Array.from(files).forEach((file, idx) => {
      const reader = new FileReader();
      reader.onload = e => {
        const div = document.createElement("div");
        div.className = "preview-item";
        div.innerHTML = `
          <img src="${e.target.result}" alt="">
          <div class="preview-label">
            ${containerId === "coverPreview" && idx === 0 ? "ëŒ€í‘œ" : "ì´ë¯¸ì§€"}
          </div>
        `;
        box.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  }

  document.getElementById("cover").addEventListener("change", e => {
    createPreview("coverPreview", e.target.files);
  });

  document.getElementById("images").addEventListener("change", e => {
    createPreview("imagesPreview_new", e.target.files);
  });

  // =====================================================
  // âœ… ê¸°ì¡´ ì´ë¯¸ì§€ ë Œë”(ì‚­ì œ + ë“œë˜ê·¸)
  // =====================================================
  function renderExistingImages() {
    const box = document.getElementById("imagesPreview");
    box.innerHTML = "";

    existingImages.forEach((src, idx) => {
      const div = document.createElement("div");
      div.className = "preview-item";
      div.draggable = true;
      div.dataset.index = String(idx);
      div.innerHTML = `
        <img src="${src}" alt="">
        <div class="preview-label">${idx === 0 ? "ëŒ€í‘œ(ê¸°ì¡´)" : "ê¸°ì¡´ ì´ë¯¸ì§€"}</div>
        <button type="button" class="img-delete-btn" data-idx="${idx}" title="ì‚­ì œ">âœ•</button>
      `;
      box.appendChild(div);
    });

    bindDeleteButtons();
    enableDragSort();

    // ëŒ€í‘œ ì´ë¯¸ì§€ í”„ë¦¬ë·°(ì»¤ë²„ íŒŒì¼ì„ ìƒˆë¡œ ì„ íƒí•˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ) ì—…ë°ì´íŠ¸
    const coverSelected = document.getElementById("cover").files.length > 0;
    if (!coverSelected) {
      const main = existingImages[0];
      if (main) {
        document.getElementById("coverPreview").innerHTML = `
          <div class="preview-item">
            <img src="${main}" alt="">
            <div class="preview-label">í˜„ì¬ ëŒ€í‘œ ì´ë¯¸ì§€</div>
          </div>
        `;
      } else {
        document.getElementById("coverPreview").innerHTML = "";
      }
    }
  }

  function bindDeleteButtons() {
    document.querySelectorAll(".img-delete-btn").forEach(btn => {
      btn.onclick = () => {
        const idx = Number(btn.dataset.idx);
        existingImages.splice(idx, 1);
        renderExistingImages();
      };
    });
  }

  function enableDragSort() {
    const items = Array.from(document.querySelectorAll("#imagesPreview .preview-item"));
    let dragSrcIdx = null;

    items.forEach(item => {
      item.addEventListener("dragstart", () => {
        dragSrcIdx = Number(item.dataset.index);
        item.classList.add("dragging");
      });

      item.addEventListener("dragend", () => {
        item.classList.remove("dragging");
        items.forEach(x => x.classList.remove("drag-over"));
      });

      item.addEventListener("dragover", (e) => {
        e.preventDefault();
        item.classList.add("drag-over");
      });

      item.addEventListener("dragleave", () => {
        item.classList.remove("drag-over");
      });

      item.addEventListener("drop", (e) => {
        e.preventDefault();
        item.classList.remove("drag-over");

        const targetIdx = Number(item.dataset.index);
        if (dragSrcIdx === null || dragSrcIdx === targetIdx) return;

        const moved = existingImages.splice(dragSrcIdx, 1)[0];
        existingImages.splice(targetIdx, 0, moved);
        renderExistingImages();
      });
    });
  }

  // =====================================================
  // ğŸ“¥ ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  // =====================================================
  async function loadDetail() {
    if (!galleryId) return; // ì‘ì„± ëª¨ë“œë©´ í†µê³¼

    try {
      const res = await fetch(`/api/gallery/detail/${galleryId}`, {
        headers: { Authorization: "Bearer " + (localStorage.getItem("token") || "") }
      });

      if (!res.ok) {
        const out = await res.json().catch(() => ({}));
        throw new Error(out.message || `HTTP ${res.status}`);
      }

      const data = await res.json();

      document.getElementById("lang").value = data.lang || "kr";
      document.getElementById("title").value = data.title || "";
      editor.setHTML(data.description || "");

      existingImages = Array.isArray(data.images) ? [...data.images] : [];
      originalExistingImages = [...existingImages];

      // ê¸°ì¡´ ì´ë¯¸ì§€ ì˜ì—­ ë Œë”
      renderExistingImages();

    } catch (e) {
      console.error("ê°¤ëŸ¬ë¦¬ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:", e);
      alert("ê¸°ì¡´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // =====================================================
  // ğŸ’¾ ì €ì¥ (ì‘ì„± / ìˆ˜ì • ê³µìš©)
  // =====================================================
  async function saveGallery() {
    const title = document.getElementById("title").value.trim();
    const lang = document.getElementById("lang").value;
    const description = editor.getHTML() || "";

    if (!title) {
      alert("ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      document.getElementById("title").focus();
      return;
    }

    // âœ… ìˆ˜ì • ëª¨ë“œì—ì„œ: ê¸°ì¡´/ìƒˆ ì´ë¯¸ì§€ ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë§‰ê¸°
    const coverFile = document.getElementById("cover").files[0];
    const newImages = document.getElementById("images").files;
    if (galleryId && existingImages.length === 0 && !coverFile && newImages.length === 0) {
      alert("ì´ë¯¸ì§€ëŠ” ìµœì†Œ 1ê°œ í•„ìš”í•©ë‹ˆë‹¤. (ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.)");
      return;
    }

    const form = new FormData();
    form.append("title", title);
    form.append("lang", lang);
    form.append("description", description);

    // âœ… ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ: ê¸°ì¡´ ì´ë¯¸ì§€ ìƒíƒœ ì „ë‹¬(ì‚­ì œ/ì •ë ¬ ë°˜ì˜)
    if (galleryId) {
      form.append("existingImages", JSON.stringify(existingImages));
      form.append("originalImages", JSON.stringify(originalExistingImages));
    }

    // âœ… ëŒ€í‘œ ì´ë¯¸ì§€(ì„ íƒ): ì„œë²„ì—ì„œëŠ” ìƒˆ ì—…ë¡œë“œ ì´ë¯¸ì§€ ì¤‘ ì²«ë²ˆì§¸ë¡œ ì·¨ê¸‰ ê°€ëŠ¥
    if (coverFile) form.append("images", coverFile);

    // âœ… ì¶”ê°€ ì´ë¯¸ì§€
    for (const img of newImages) form.append("images", img);

    const token = localStorage.getItem("token") || "";
    const url = galleryId ? `/api/gallery/edit/${galleryId}` : `/api/gallery/create`;
    const method = galleryId ? "PUT" : "POST";

    try {
      const res = await fetch(url, {
        method,
        headers: { Authorization: "Bearer " + token },
        body: form
      });

      const out = await res.json().catch(() => ({}));

      if (res.ok) {
        alert(galleryId ? "ìˆ˜ì • ì™„ë£Œ" : "ë“±ë¡ ì™„ë£Œ");
        location.href = "gallery-list.html";
      } else {
        alert("ì €ì¥ ì‹¤íŒ¨: " + (out.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    } catch (e) {
      console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", e);
      alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // =====================================================
  // ğŸš€ ì´ˆê¸° ì‹¤í–‰
  // =====================================================
  // âœ… ìƒˆ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì„ ê¸°ì¡´/ì‹ ê·œ ë¶„ë¦¬ (êµ¬ì„±ì€ ìœ ì§€í•˜ë˜ DOMë§Œ 1ì¤„ ì¶”ê°€)
  (function ensureNewPreviewBox(){
    const box = document.getElementById("imagesPreview");
    if (!document.getElementById("imagesPreview_new")) {
      const div = document.createElement("div");
      div.id = "imagesPreview_new";
      div.className = "preview-row";
      div.style.marginTop = "12px";
      // ê¸°ì¡´ imagesPreview ì•„ë˜ì— ì‹ ê·œ ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ë§Œ í•˜ë‚˜ ì¶”ê°€(ë ˆì´ì•„ì›ƒë§Œ)
      box.insertAdjacentElement("afterend", div);
    }
  })();

  loadDetail();
</script>



</body>
</html>
