<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê°¤ëŸ¬ë¦¬ ì‘ì„±/ìˆ˜ì • | Fine Defense Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Toast UI Editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/kr/admin/css/admin.css" />

  <style>
    .form-box {
      background:#fff;
      padding:25px 30px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      max-width:900px;
      margin:30px auto 60px;
    }

    .form-box label {
      display:block;
      margin:14px 0 6px;
      font-weight:600;
    }

    .form-box input[type="text"],
    .form-box select {
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:0.95rem;
      box-sizing:border-box;
    }

    .preview-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }

    .preview-item img {
      width:120px;
      height:80px;
      object-fit:cover;
      border-radius:8px;
      border:1px solid #ddd;
    }

    .preview-label {
      font-size:0.8rem;
      color:#666;
      margin-top:3px;
      text-align:center;
    }

    .btn-row {
      margin-top:24px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
  </style>
</head>

<body>

<div id="sidebar" data-active="gallery"></div>

<div class="main">
  <div class="topbar">
    <h2>ê°¤ëŸ¬ë¦¬ ì‘ì„± / ìˆ˜ì •</h2>
    <div>
      <button class="btn btn-primary" onclick="location.href='gallery-list.html'">ëª©ë¡</button>
      <button id="logoutBtn" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <div class="form-box">
    <label>ì–¸ì–´</label>
    <select id="lang">
      <option value="kr">KR</option>
      <option value="en">EN</option>
    </select>

    <label>ì œëª© <span style="color:#c00;">*</span></label>
    <input id="title" type="text" placeholder="ê°¤ëŸ¬ë¦¬ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.">

    <label>ëŒ€í‘œ ì´ë¯¸ì§€ (ì¸ë„¤ì¼)</label>
    <input id="cover" type="file" accept="image/*">
    <div id="coverPreview" class="preview-row"></div>

    <label>ì¶”ê°€ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ ê°€ëŠ¥)</label>
    <input id="images" type="file" accept="image/*" multiple>
    <div id="imagesPreview" class="preview-row"></div>

    <label>ì„¤ëª… (ì„ íƒ)</label>
    <div id="editor" style="margin-top:8px;"></div>

    <div class="btn-row">
      <button class="btn btn-gray" onclick="location.href='gallery-list.html'">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveGallery()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
  // ê¶Œí•œ ì²´í¬ & ì‚¬ì´ë“œë°”
  requireAdminOrEditor();
  document.getElementById("logoutBtn").addEventListener("click", logout);
  loadSidebar("gallery");

  const urlParams = new URLSearchParams(location.search);
  const galleryId = urlParams.get("id");

  // Toast UI Editor
  const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '400px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    initialValue: ''
  });

  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê³µí†µ í•¨ìˆ˜
  function createPreview(containerId, files) {
    const box = document.getElementById(containerId);
    box.innerHTML = "";

    Array.from(files).forEach((file, idx) => {
      const reader = new FileReader();
      reader.onload = e => {
        const div = document.createElement("div");
        div.className = "preview-item";
        div.innerHTML = `
          <img src="${e.target.result}" alt="">
          <div class="preview-label">${idx === 0 && containerId === 'coverPreview' ? 'ëŒ€í‘œ' : 'ì´ë¯¸ì§€'}</div>
        `;
        box.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  }

  document.getElementById("cover").addEventListener("change", (e) => {
    if (e.target.files.length) {
      createPreview("coverPreview", e.target.files);
    } else {
      document.getElementById("coverPreview").innerHTML = "";
    }
  });

  document.getElementById("images").addEventListener("change", (e) => {
    if (e.target.files.length) {
      createPreview("imagesPreview", e.target.files);
    } else {
      document.getElementById("imagesPreview").innerHTML = "";
    }
  });

  async function loadDetail() {
    if (!galleryId) return;

    try {
      const res = await fetch(`/api/gallery/detail/${galleryId}`);
      const data = await res.json();

      document.getElementById("lang").value = data.lang || "kr";
      document.getElementById("title").value = data.title || "";
      editor.setHTML(data.description || "");

      // ê¸°ì¡´ ëŒ€í‘œ ì´ë¯¸ì§€ í”„ë¦¬ë·°
      if (data.cover_image) {
        const box = document.getElementById("coverPreview");
        box.innerHTML = `
          <div class="preview-item">
            <img src="${data.cover_image}" alt="">
            <div class="preview-label">í˜„ì¬ ëŒ€í‘œ ì´ë¯¸ì§€</div>
          </div>
        `;
      }

      // ê¸°ì¡´ ì¶”ê°€ ì´ë¯¸ì§€ í”„ë¦¬ë·°
      if (data.images && data.images.length) {
        const box = document.getElementById("imagesPreview");
        box.innerHTML = data.images.map(src => `
          <div class="preview-item">
            <img src="${src}" alt="">
            <div class="preview-label">ë“±ë¡ëœ ì´ë¯¸ì§€</div>
          </div>
        `).join("");
      }

    } catch (e) {
      console.error("ê°¤ëŸ¬ë¦¬ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", e);
      alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

async function saveGallery() {
  const title = document.getElementById("title").value.trim();
  const lang = document.getElementById("lang").value;
  const description = editor.getHTML() || "";

  if (!title) {
    alert("ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    document.getElementById("title").focus();
    return;
  }

  const form = new FormData();
  form.append("title", title);
  form.append("lang", lang);
  form.append("description", description);

  // ğŸ”¥ ëŒ€í‘œ ì´ë¯¸ì§€(cover)ë„ images[]ë¡œ í†µì¼í•´ì„œ append
  const coverFile = document.getElementById("cover").files[0];
  if (coverFile) {
    form.append("images", coverFile); // â˜… ìˆ˜ì • í¬ì¸íŠ¸
  }

  // ğŸ”¥ ì¶”ê°€ ì´ë¯¸ì§€ë„ ë™ì¼í•˜ê²Œ append
  const images = document.getElementById("images").files;
  for (const img of images) {
    form.append("images", img); // â˜… ìˆ˜ì • í¬ì¸íŠ¸
  }

  const token = localStorage.getItem("token");
  let url, method;

  if (galleryId) {
    url = `/api/gallery/edit/${galleryId}`;
    method = "PUT";
  } else {
    url = `/api/gallery/create`;
    method = "POST";
  }

  try {
    const res = await fetch(url, {
      method,
      headers: { Authorization: "Bearer " + token },
      body: form,
    });

    const out = await res.json().catch(() => ({}));

    if (res.ok) {
      alert(galleryId ? "ìˆ˜ì • ì™„ë£Œ" : "ë“±ë¡ ì™„ë£Œ");
      location.href = "gallery-list.html";
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (out.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  } catch (e) {
    console.error("ê°¤ëŸ¬ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e);
    alert("í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


  // ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš° ë°ì´í„° ë¡œë“œ
  loadDetail();
</script>

</body>
</html>
