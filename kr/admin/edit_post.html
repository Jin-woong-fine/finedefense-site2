<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게시물 수정 | Fine Defense 관리자</title>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
    }

    header {
      background: #0f2679;
      color: #fff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { font-size: 1.3rem; }
    header button {
      background: #fff;
      color: #0f2679;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }

    main {
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
    }

    .form-box {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 30px;
    }

    select, input {
      width: 100%;
      padding: 10px;
      margin: 6px 0 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    .btn {
      background: #0f2679;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      margin-top: 20px;
    }

    .image-preview-box {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .preview-item {
      position: relative;
      display: inline-block;
    }

    .preview-item img {
      width: 90px;
      height: 90px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 3px;
    }

    .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: crimson;
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>

<body>

<header>
  <h1>게시물 수정</h1>
  <button onclick="location.href='/kr/admin/dashboard.html'">대시보드</button>
</header>

<main>

  <div class="form-box">
    <h2>게시물 정보 수정</h2>

    <select id="category">
      <option value="news">뉴스룸</option>
      <option value="notice">공지사항</option>
      <option value="gallery">갤러리</option>
    </select>

    <select id="lang">
      <option value="kr">한국어</option>
      <option value="en">English</option>
    </select>

    <input type="text" id="title" placeholder="제목을 입력하세요">

    <div id="editor" style="height: 300px; background: white; border:1px solid #ccc; border-radius:6px;"></div>

    <h3 style="margin-top:25px;">기존 이미지</h3>
    <div id="existingImages" class="image-preview-box"></div>

    <h3>새로운 이미지 추가</h3>
    <input type="file" id="newImages" multiple>
    <div id="newPreview" class="image-preview-box"></div>

    <button class="btn" id="saveBtn">수정 내용 저장</button>
  </div>

</main>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
/* -------------------------------------------
    기본 설정
------------------------------------------- */
const API_URL = "/api";
const urlParams = new URLSearchParams(window.location.search);
const postId = urlParams.get("id");

const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "admin") {
  alert("권한이 없습니다. 로그인 해주세요.");
  location.href = "/kr/admin/login.html";
}

/* -------------------------------------------
    에디터 세팅
------------------------------------------- */
const quill = new Quill("#editor", {
  theme: "snow",
  modules: {
    toolbar: [
      [{ header: [1, 2, false] }],
      ["bold", "italic", "underline"],
      [{ list: "ordered" }, { list: "bullet" }],
      ["link", "image"],
      ["clean"],
    ],
  },
});

/* -------------------------------------------
    기존 게시물 데이터 불러오기
------------------------------------------- */
async function loadPost() {
  const res = await fetch(`${API_URL}/posts/${postId}`);
  const post = await res.json();

  document.getElementById("title").value = post.title;
  document.getElementById("category").value = post.category;
  document.getElementById("lang").value = post.lang;

  quill.root.innerHTML = post.content;

  renderExistingImages(post.images || []);
}

loadPost();

/* -------------------------------------------
    기존 이미지 표시 + 삭제 버튼
------------------------------------------- */
let removedImages = [];

function renderExistingImages(images) {
  const box = document.getElementById("existingImages");
  box.innerHTML = "";

  images.forEach(img => {
    const wrap = document.createElement("div");
    wrap.className = "preview-item";

    const image = document.createElement("img");
    image.src = img;

    const btn = document.createElement("button");
    btn.className = "remove-btn";
    btn.textContent = "×";

    btn.onclick = () => {
      removedImages.push(img);
      wrap.remove();
    };

    wrap.appendChild(image);
    wrap.appendChild(btn);
    box.appendChild(wrap);
  });
}

/* -------------------------------------------
    새 이미지 미리보기
------------------------------------------- */
let newImageFiles = [];

document.getElementById("newImages").addEventListener("change", e => {
  const files = Array.from(e.target.files);
  newImageFiles = newImageFiles.concat(files);
  previewNewImages();
});

function previewNewImages() {
  const box = document.getElementById("newPreview");
  box.innerHTML = "";

  newImageFiles.forEach((file, idx) => {
    const reader = new FileReader();
    reader.onload = e => {
      const wrap = document.createElement("div");
      wrap.className = "preview-item";

      const img = document.createElement("img");
      img.src = e.target.result;

      const btn = document.createElement("button");
      btn.className = "remove-btn";
      btn.textContent = "×";

      btn.onclick = () => {
        newImageFiles.splice(idx, 1);
        previewNewImages();
      };

      wrap.appendChild(img);
      wrap.appendChild(btn);
      box.appendChild(wrap);
    };
    reader.readAsDataURL(file);
  });
}

/* -------------------------------------------
    저장 (PUT)
------------------------------------------- */
document.getElementById("saveBtn").addEventListener("click", async () => {
  const title = document.getElementById("title").value.trim();
  const content = quill.root.innerHTML.trim();

  if (!title) return alert("제목을 입력하세요.");
  if (!content.replace(/<p><br><\/p>/g, "").trim())
    return alert("내용을 입력하세요.");

  const fd = new FormData();
  fd.append("title", title);
  fd.append("content", content);
  fd.append("category", document.getElementById("category").value);
  fd.append("lang", document.getElementById("lang").value);

  // 삭제할 기존 이미지
  fd.append("removedImages", JSON.stringify(removedImages));

  // 새로 추가한 이미지
  newImageFiles.forEach(f => fd.append("newImages", f));

  const res = await fetch(`${API_URL}/posts/${postId}`, {
    method: "PUT",
    headers: { Authorization: `Bearer ${token}` },
    body: fd,
  });

  if (!res.ok) {
    alert("수정 실패! 서버 로그 확인 필요");
    return;
  }

  alert("수정 완료!");
  location.href = "/kr/admin/dashboard.html";
});
</script>

</body>
</html>
