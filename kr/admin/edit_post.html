<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게시물 수정 | Fine Defense</title>

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/sub-banner.css">

  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background:#f5f7fb; margin:0; }
    .container {
      max-width: 900px; margin: 40px auto; background:#fff; padding: 30px;
      border-radius: 12px; box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .row { margin-bottom: 20px; }
    label { font-weight: bold; margin-bottom: 6px; display: block; }
    input, select {
      width: 100%; padding: 10px; border-radius: 6px; border:1px solid #ccc;
      font-size: 15px;
    }
    #editor {
      height: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px;
    }
    #currentImages img {
      width:100px; height:100px; object-fit:cover; border-radius:6px;
      border:1px solid #ccc; margin-right:10px;
    }
    #newPreview img {
      width:100px; height:100px; object-fit:cover; border-radius:6px;
      border:1px solid #ccc; margin-right:10px;
    }
    button {
      padding: 10px 20px; background:#0f2679; color:#fff;
      border:none; border-radius:6px; cursor:pointer; margin-top:20px;
    }
  </style>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>

<body>
  <div class="container">
    <h2>게시물 수정</h2>

    <div class="row">
      <label>카테고리</label>
      <select id="category">
        <option value="news">뉴스룸</option>
        <option value="notice">공지사항</option>
        <option value="gallery">갤러리</option>
      </select>
    </div>

    <div class="row">
      <label>언어</label>
      <select id="lang">
        <option value="kr">한국어</option>
        <option value="en">English</option>
      </select>
    </div>

    <div class="row">
      <label>제목</label>
      <input id="title">
    </div>

    <div class="row">
      <label>본문</label>
      <div id="editor"></div>
    </div>

    <div class="row">
      <label>현재 이미지</label>
      <div id="currentImages" style="display:flex; gap:10px;"></div>
    </div>

    <div class="row">
      <label>새 이미지 업로드 (선택)</label>
      <input type="file" id="newImages" multiple accept="image/*">
      <div id="newPreview" style="display:flex; gap:10px; margin-top:10px;"></div>
    </div>

    <button id="saveBtn">수정 완료</button>
    <button onclick="history.back()" style="background:gray;">뒤로가기</button>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
  const API_URL = "/api";
  const token = localStorage.getItem("token");

  if (!token) {
    alert("로그인이 필요합니다.");
    location.href = "/kr/admin/login.html";
  }

  const postId = new URLSearchParams(location.search).get("id");

  let quill;

  document.addEventListener("DOMContentLoaded", () => {

    quill = new Quill("#editor", {
      theme: "snow",
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ["bold", "italic", "underline"],
          [{ list: "ordered" }, { list: "bullet" }],
          ["link", "image"],
          ["clean"]
        ]
      }
    });

    loadPost();

    document.getElementById("newImages").addEventListener("change", previewNewImages);

    document.getElementById("saveBtn").addEventListener("click", savePost);
  });

  async function loadPost() {
    const res = await fetch(`${API_URL}/posts/detail/${postId}`);
    const post = await res.json();

    document.getElementById("title").value = post.title;
    document.getElementById("category").value = post.category;
    document.getElementById("lang").value = post.lang;

    quill.root.innerHTML = post.content;

    const imgWrap = document.getElementById("currentImages");
    imgWrap.innerHTML = post.images
      .map(img => `<img src="${img}">`)
      .join("");
  }

  function previewNewImages(e) {
    const preview = document.getElementById("newPreview");
    preview.innerHTML = "";

    Array.from(e.target.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = ev => {
        preview.innerHTML += `<img src="${ev.target.result}">`;
      };
      reader.readAsDataURL(file);
    });
  }

  async function savePost() {
    const fd = new FormData();

    fd.append("title", document.getElementById("title").value);
    fd.append("category", document.getElementById("category").value);
    fd.append("lang", document.getElementById("lang").value);
    fd.append("content", quill.root.innerHTML);

    const newFiles = document.getElementById("newImages").files;
    Array.from(newFiles).forEach(f => fd.append("images", f));

    const res = await fetch(`${API_URL}/posts/${postId}`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${token}` },
      body: fd
    });

    if (res.ok) {
      alert("수정 완료!");
      location.href = "/kr/admin/dashboard.html";
    } else {
      alert("수정 실패");
    }
  }
  </script>

</body>
</html>
