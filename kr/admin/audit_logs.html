<!-- /kr/admin/audit_logs.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œë¬¼ ìˆ˜ì • ê¸°ë¡ | Fine Defense ê´€ë¦¬ì</title>

  <link rel="stylesheet" href="./css/admin.css">

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      vertical-align: top;
    }
    th {
      background:#eef1f7;
      font-weight:600;
    }

    .search-box {
      display:flex;
      gap:10px;
      margin-bottom:20px;
    }

    .input {
      padding:8px;
      border:1px solid #ccc;
      border-radius:6px;
    }

    .btn-search {
      padding:8px 12px;
      background:#0f2679;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }

    .action-create { color:#0a7a2f; font-weight:600; }
    .action-update { color:#0f2679; font-weight:600; }
    .action-delete { color:#c1121f; font-weight:600; }

    .content-type {
      font-weight:600;
      color:#333;
    }

    .diff-box {
      font-size:12px;
      background:#f8f9fc;
      border-radius:6px;
      padding:8px;
      white-space: pre-wrap;
      max-height:120px;
      overflow:auto;
    }

    body {
      font-family: "Noto Sans KR", sans-serif;
    }
  </style>
</head>

<body>

<div id="sidebar"></div>

<div class="main">

  <div class="topbar">
    <h2>ê²Œì‹œë¬¼ ìˆ˜ì • ê¸°ë¡</h2>
    <div>
      <button class="btn btn-primary" onclick="location.href='../index.html'">í™ˆìœ¼ë¡œ</button>
      <button id="logoutBtn" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <section class="panel">

    <!-- ğŸ” ê²€ìƒ‰ -->
    <div class="search-box">
      <input type="text" id="searchInput" class="input" placeholder="ì‘ì„±ì / ì œëª© ê²€ìƒ‰">
      <select id="actionFilter" class="input">
        <option value="">ì „ì²´ ì•¡ì…˜</option>
        <option value="CREATE">CREATE</option>
        <option value="UPDATE">UPDATE</option>
        <option value="DELETE">DELETE</option>
      </select>
      <button class="btn-search" onclick="loadAuditLogs()">ê²€ìƒ‰</button>
    </div>

    <!-- ğŸ“‹ í…Œì´ë¸” -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>ì½˜í…ì¸ </th>
          <th>ì•¡ì…˜</th>
          <th>ì‘ì„±ì</th>
          <th>IP</th>
          <th>ë³€ê²½ ë‚´ìš©</th>
          <th>ì‹œê°„</th>
        </tr>
      </thead>
      <tbody id="logTable"></tbody>
    </table>

  </section>

</div>

<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>

<script>
requireAdminOrSuperadmin();
loadSidebar("logs");
document.getElementById("logoutBtn").onclick = logout;

async function loadAuditLogs() {
  console.log("TOKEN:", localStorage.getItem("token"));
  const keyword = document.getElementById("searchInput").value.trim();
  const action = document.getElementById("actionFilter").value;

  const params = new URLSearchParams();
  if (keyword) params.append("search", keyword);
  if (action) params.append("action", action);

    const res = await fetch("/api/audit/logs?" + params.toString(), {
    headers: {
        Authorization: "Bearer " + localStorage.getItem("token")
    }
    });

    const data = await res.json();

    // âœ… ì—¬ê¸°! (forEach ì „ì—)
    if (!Array.isArray(data)) {
    console.error("Audit API error:", data);
    alert("Audit ë¡œê·¸ API ì˜¤ë¥˜ (ì„œë²„ ì—ëŸ¬)");
    return;
    }

    const tbody = document.getElementById("logTable");
    tbody.innerHTML = "";

    data.forEach(log => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td>${log.id}</td>
        <td class="content-type">${log.content_type} #${log.content_id}</td>
        <td class="action-${log.action.toLowerCase()}">${log.action}</td>
        <td>${log.actor_name || "-"}</td>
        <td>${log.ip || "-"}</td>
        <td>
        <div class="diff-box">
    ${formatDiff(log.before_data, log.after_data)}
        </div>
        </td>
        <td>${new Date(log.created_at).toLocaleString()}</td>
    `;

    tbody.appendChild(tr);
    });
}


function formatDiff(before, after) {
  // CREATE
  if (!before && after) {
    return `<span style="color:#0a7a2f;font-weight:600">ìƒì„±ë¨</span>`;
  }

  // DELETE
  if (before && !after) {
    return `<span style="color:#c1121f;font-weight:600">ì‚­ì œë¨</span>`;
  }

  // UPDATE
  if (!before || !after) return "-";

  let html = `<table style="width:100%; font-size:12px;">`;

  for (const key in after) {
    const b = before[key];
    const a = after[key];

    if (JSON.stringify(b) === JSON.stringify(a)) continue;

    const beforeVal =
      b === null || b === undefined
        ? "-"
        : typeof b === "object"
        ? JSON.stringify(b)
        : b;

    const afterVal =
      a === null || a === undefined
        ? "-"
        : typeof a === "object"
        ? JSON.stringify(a)
        : a;

    html += `
      <tr>
        <td style="width:80px;font-weight:600;color:#333">${key}</td>
        <td style="color:#c1121f;white-space:pre-wrap">${beforeVal}</td>
        <td style="color:#0a7a2f;white-space:pre-wrap">${afterVal}</td>
      </tr>
    `;
  }

  html += `</table>`;

  return html || "ë³€ê²½ ì—†ìŒ";
}


loadAuditLogs();
</script>

</body>
</html>
