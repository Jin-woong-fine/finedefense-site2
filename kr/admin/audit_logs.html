<!-- /kr/admin/audit_logs.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œë¬¼ ìˆ˜ì • ê¸°ë¡ | Fine Defense ê´€ë¦¬ì</title>

  <link rel="stylesheet" href="./css/admin.css">

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      vertical-align: top;
    }
    th {
      background:#eef1f7;
      font-weight:600;
    }

    .search-box {
      display:flex;
      gap:10px;
      margin-bottom:20px;
    }

    .input {
      padding:8px;
      border:1px solid #ccc;
      border-radius:6px;
    }

    .btn-search {
      padding:8px 12px;
      background:#0f2679;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }

    .action-create { color:#0a7a2f; font-weight:600; }
    .action-update { color:#0f2679; font-weight:600; }
    .action-delete { color:#c1121f; font-weight:600; }

    .content-type {
      font-weight:600;
      color:#333;
    }

    .diff-box {
      font-size:12px;
      background:#f8f9fc;
      border-radius:6px;
      padding:8px;
      white-space: pre-wrap;
      max-height:120px;
      overflow:auto;
    }

    body {
      font-family: "Noto Sans KR", sans-serif;
    }
  </style>
</head>

<body>

<div id="sidebar"></div>

<div class="main">

  <div class="topbar">
    <h2>ê²Œì‹œë¬¼ ìˆ˜ì • ê¸°ë¡</h2>
    <div>
      <button class="btn btn-primary" onclick="location.href='../index.html'">í™ˆìœ¼ë¡œ</button>
      <button id="logoutBtn" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <section class="panel">

    <!-- ğŸ” ê²€ìƒ‰ -->
    <div class="search-box">
      <input type="text" id="searchInput" class="input" placeholder="ì‘ì„±ì / ì œëª© ê²€ìƒ‰">
      <select id="actionFilter" class="input">
        <option value="">ì „ì²´ ì•¡ì…˜</option>
        <option value="CREATE">CREATE</option>
        <option value="UPDATE">UPDATE</option>
        <option value="DELETE">DELETE</option>
      </select>
      <button class="btn-search" onclick="loadAuditLogs()">ê²€ìƒ‰</button>
    </div>

    <!-- ğŸ“‹ í…Œì´ë¸” -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>ì½˜í…ì¸ </th>
          <th>ì•¡ì…˜</th>
          <th>ì‘ì„±ì</th>
          <th>IP</th>
          <th>ë³€ê²½ ë‚´ìš©</th>
          <th>ì‹œê°„</th>
        </tr>
      </thead>
      <tbody id="logTable"></tbody>
    </table>

  </section>

</div>

<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>

<script>
requireAdminOrSuperadmin();
loadSidebar("logs");
document.getElementById("logoutBtn").onclick = logout;

async function loadAuditLogs() {
  const keyword = document.getElementById("searchInput").value.trim();
  const action = document.getElementById("actionFilter").value;

  const params = new URLSearchParams();
  if (keyword) params.append("search", keyword);
  if (action) params.append("action", action);

  const res = await fetch("/api/audit/logs?" + params.toString(), {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  });

  const data = await res.json();
  const tbody = document.getElementById("logTable");
  tbody.innerHTML = "";

  data.forEach(log => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${log.id}</td>
      <td class="content-type">${log.content_type} #${log.content_id}</td>
      <td class="action-${log.action.toLowerCase()}">${log.action}</td>
      <td>${log.actor_name || "-"}</td>
      <td>${log.ip || "-"}</td>
      <td>
        <div class="diff-box">
${formatDiff(log.before_data, log.after_data)}
        </div>
      </td>
      <td>${new Date(log.created_at).toLocaleString()}</td>
    `;

    tbody.appendChild(tr);
  });
}

function formatDiff(before, after) {
  if (!before && after) return "â–¶ ìƒì„±ë¨";
  if (before && !after) return "â–¶ ì‚­ì œë¨";

  if (!before || !after) return "-";

  const diff = [];
  for (const key in after) {
    if (before[key] !== after[key]) {
      diff.push(`${key}: "${before[key]}" â†’ "${after[key]}"`);
    }
  }
  return diff.length ? diff.join("\n") : "ë³€ê²½ ì—†ìŒ";
}

loadAuditLogs();
</script>

</body>
</html>
