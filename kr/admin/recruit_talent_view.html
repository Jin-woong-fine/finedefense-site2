<!-- /kr/admin/talent-view.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¸ì¬ DB ìƒì„¸ | Fine Defense Admin</title>

  <!-- ê³µí†µ ê´€ë¦¬ì CSS -->
    <link rel="stylesheet" href="/kr/admin/css/admin.css">

  <!-- ì„¸ì…˜ ë§¤ë‹ˆì € -->
    <script type="module" src="/js/session_manager.js"></script>
    <script type="module" src="/kr/admin/js/dashboard_session_timer.js"></script>

  <style>
    .panel {
      background: #fff;
      padding: 28px 32px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(15,38,121,0.08);
      max-width: 900px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      row-gap: 14px;
      column-gap: 20px;
      margin-bottom: 26px;
      font-size: 0.95rem;
    }

    .info-label {
      color: #555;
      font-weight: 600;
    }

    .info-value {
      color: #111;
    }

    .message-box {
      border: 1px solid #e1e6f5;
      border-radius: 8px;
      padding: 16px;
      background: #f9fbff;
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .file-list {
      margin-top: 18px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .file-item a {
      color: #0f2679;
      font-weight: 600;
      text-decoration: none;
    }

    .file-item a:hover {
      text-decoration: underline;
    }

    .actions {
      margin-top: 28px;
      display: flex;
      gap: 10px;
    }
  </style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar" data-active="recruit"></div>

<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="title">ì¸ì¬ DB ìƒì„¸</div>

    <div style="display:flex; align-items:center; gap:12px;">
      <span id="session-timer" class="session-timer">ì„¸ì…˜ ê³„ì‚°ì¤‘...</span>

      <div class="topbar-user" id="topbarUser">
        <span id="topbarUserName">ê´€ë¦¬ì</span> â–¾
        <div class="user-dropdown" id="userDropdown"></div>
      </div>

      <button onclick="goBackToList()">ëª©ë¡ìœ¼ë¡œ</button>
    </div>
  </div>

  <section class="panel">

    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="info-grid">
      <div class="info-label">ì´ë¦„</div>
      <div class="info-value" id="name">-</div>

      <div class="info-label">ì´ë©”ì¼</div>
      <div class="info-value" id="email">-</div>

      <div class="info-label">ë“±ë¡ì¼</div>
      <div class="info-value" id="created">-</div>

      <div class="info-label">IP ì£¼ì†Œ</div>
      <div class="info-value" id="ip">-</div>
    </div>

    <!-- ìê¸°ì†Œê°œ -->
    <h3 style="margin-bottom:10px;">ìê¸°ì†Œê°œ / ì „ë‹¬ì‚¬í•­</h3>
    <div class="message-box" id="message">-</div>

    <!-- ì²¨ë¶€íŒŒì¼ -->
    <div class="file-list">
      <h3 style="margin-bottom:10px;">ì²¨ë¶€íŒŒì¼</h3>

    <div class="file-item">
      <span>ğŸ“„ ì´ë ¥ì„œ</span>
      <a id="file-resume" href="#" target="_blank" style="display:none;">ë‹¤ìš´ë¡œë“œ</a>
      <!--<button id="btn-preview-resume"
              class="btn btn-small btn-gray"
              style="display:none;"
              onclick="previewFile(this.dataset.url)">
        ë¯¸ë¦¬ë³´ê¸°
      </button>-->
      <span id="file-resume-none">ì—†ìŒ</span>
    </div>

      <div class="file-item">
        <span>ğŸ“„ ìê¸°ì†Œê°œì„œ</span>
        <a id="file-cover" href="#" target="_blank" style="display:none;">ë‹¤ìš´ë¡œë“œ</a>
        <!--<button id="btn-preview-cover"
                class="btn btn-small btn-gray"
                style="display:none;"
                onclick="previewFile(this.dataset.url)">
        ë¯¸ë¦¬ë³´ê¸°
      </button>-->
        <span id="file-cover-none">ì—†ìŒ</span>
      </div>

      <div class="file-item">
        <span>ğŸ“ ì°¸ê³ ìë£Œ</span>
        <a id="file-portfolio" href="#" target="_blank" style="display:none;">ë‹¤ìš´ë¡œë“œ</a>
        <!--<button id="btn-preview-portfolio"
                class="btn btn-small btn-gray"
                style="display:none;"
                onclick="previewFile(this.dataset.url)">
          ë¯¸ë¦¬ë³´ê¸°
        </button> -->    
        <span id="file-portfolio-none">ì—†ìŒ</span>
      </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <!--<div id="file-preview" style="margin-top:20px; display:none;">
      <h3 style="margin-bottom:10px;">íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
      <div id="preview-container"></div>
    </div>-->


    <!-- ì•¡ì…˜ -->
    <div class="actions">
      <button class="btn btn-danger" onclick="deleteThis()">ì‚­ì œ</button>
      <button class="btn btn-gray" onclick="goBackToList()">ëª©ë¡ìœ¼ë¡œ</button>
    </div>

  </section>
</div>

<script src="/kr/admin/js/common_auth.js"></script>
<script src="/kr/admin/js/sidebar.js"></script>
<script src="/kr/admin/js/topbar_user_menu.js"></script>

<script>
requireEditPermission();
loadSidebar("recruit");

/* ===============================
   ë°ì´í„° ë¡œë“œ
=============================== */
const params = new URLSearchParams(location.search);
const id = params.get("id");

async function loadDetail() {
  if (!id) {
    alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
    return;
  }

  const token = localStorage.getItem("token");
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    location.replace("/kr/admin/login.html");
    return;
  }

  const res = await fetch(`/api/recruit/talent/${id}`, {
    headers: {
      Authorization: "Bearer " + token
    }
  });

  if (res.status === 401 || res.status === 403) {
    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    location.replace("/kr/admin/login.html");
    return;
  }

  if (!res.ok) {
    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ğŸ”¥ ì´ ì¤„ì´ ì—†ì–´ì„œ ì—ëŸ¬ ë‚œ ê±°ë‹¤
  const t = await res.json();

  // =========================
  // ì—¬ê¸°ë¶€í„°ëŠ” ì „ë¶€ ì •ìƒ
  // =========================
  document.getElementById("name").innerText = t.name;
  document.getElementById("email").innerText = t.email;
  document.getElementById("created").innerText = t.created_at.slice(0, 10);
  document.getElementById("ip").innerText = t.ip_address || "-";
  document.getElementById("message").innerText = t.message || "-";

  // íŒŒì¼ ë§í¬
  if (t.resume_path) {
    const url = `/api/recruit/talent/file/${id}/resume`;

    const a = document.getElementById("file-resume");
    a.href = url;
    a.style.display = "inline";
    document.getElementById("file-resume-none").style.display = "none";

  }
  if (t.cover_path) {
    const url = `/api/recruit/talent/file/${id}/cover`;

    const a = document.getElementById("file-cover");
    a.href = url;
    a.style.display = "inline";
    document.getElementById("file-cover-none").style.display = "none";


  }
  if (t.portfolio_path) {
    const url = `/api/recruit/talent/file/${id}/portfolio`;

    const a = document.getElementById("file-portfolio");
    a.href = url;
    a.style.display = "inline";
    document.getElementById("file-portfolio-none").style.display = "none";


  }
}

/* ===============================
   ì‚­ì œ
=============================== */
async function deleteThis() {
  if (!confirm("ì´ ì¸ì¬ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const res = await fetch(`/api/recruit/talent/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  });

  if (!res.ok) {
    alert("ì‚­ì œ ì‹¤íŒ¨");
    return;
  }

  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
  location.href = "/kr/admin/recruit-manage.html";
}


async function previewFile(url) {
  const box = document.getElementById("file-preview");
  const container = document.getElementById("preview-container");

  container.innerHTML = "";
  box.style.display = "block";

  try {
    const res = await fetch(url, {
      method: "HEAD",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token")
      }
    });

    if (!res.ok) {
      container.innerHTML = "<p>íŒŒì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
      return;
    }

    const type = res.headers.get("Content-Type") || "";

    // âœ… PDF
    if (type.includes("application/pdf")) {
      container.innerHTML = `
        <iframe
          src="${url}"
          style="width:100%; height:600px; border:1px solid #ddd;"
        ></iframe>
      `;
      return;
    }

    // âœ… ì´ë¯¸ì§€ (jpg, png, jpeg, gif ë“±)
    if (type.startsWith("image/")) {
      container.innerHTML = `
        <img
          src="${url}"
          style="max-width:100%; border:1px solid #ddd;"
        />
      `;
      return;
    }

    // âŒ ê·¸ ì™¸ íŒŒì¼
    container.innerHTML = "<p>ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.</p>";

  } catch (err) {
    console.error("ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜:", err);
    container.innerHTML = "<p>ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
  }
}

function goBackToList() {
  location.href = "/kr/admin/recruit-manage.html";
}






loadDetail();
</script>

</body>
</html>
